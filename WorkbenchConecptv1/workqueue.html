<!DOCTYPE html>
<html lang="en">
<head>
  <title>Underwriting Workbench — Work Queue</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#6F1111; --brand-2:#7A1414;
      --ink:#0F1216; --text:#2A2F33; --muted:#6B757E;
      --bg:#F6F7F9; --surface:#fff; --border:#E6E9EE; --shadow:0 10px 30px rgba(17,20,24,.06),0 2px 8px rgba(17,20,24,.04);
      --green:#2E7D32; --amber:#FB8C00; --blue:#1976D2; --purple:#7C3AED; --grey:#667085;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
    .appbar{position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:280px 1fr auto;gap:16px;align-items:center;
      padding:14px 20px;background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#fff,rgba(255,255,255,.9));display:grid;place-items:center}
    .logo svg{width:22px;height:22px;fill:var(--brand)}
    .title{font-weight:800}
    .appnav{display:flex;gap:8px}
    .navbtn{border:none;background:rgba(255,255,255,.14);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .navbtn.primary{background:#fff;color:var(--brand)}
    .profile{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.24);border-radius:999px;padding:6px 10px 6px 6px}
    .avatar{width:34px;height:34px;border-radius:999px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}
    .wrap{max-width:1680px;margin:0 auto;padding:22px;display:grid;gap:16px}

    /* Sticky search */
    .stickySearch{position:sticky; top:96px; z-index:900; display:flex; align-items:center; gap:10px; padding:10px;
      background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
      transition:background .2s, backdrop-filter .2s, border-color .2s}
    .stickySearch.frosted{background:rgba(255,255,255,.7); backdrop-filter: blur(10px) saturate(160%); border-color:#DADDE5;}
    .searchInput{flex:1;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .searchInput input{border:none;outline:none;flex:1;font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
    .chip.active{background:#ffe3e3;border-color:#ffc9c9;color:#6F1111}
    .btn2{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
    .btn2.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:transparent;color:#fff}
    .icon{width:18px;height:18px;fill:var(--grey);stroke:var(--grey)}

    /* Kanban */
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    .col{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:80vh;transition:all 0.2s ease}
    .col:hover{box-shadow:0 12px 30px rgba(17,20,24,.08),0 4px 12px rgba(17,20,24,.06)}
    .col .hd{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);background:#f8f9fa}
    .bucket{flex:1;padding:16px;display:grid;gap:12px;overflow:visible}
    .bucket:empty::before{content:"Drop risks here";color:#6B757E;font-style:italic;text-align:center;padding:40px;opacity:0.6}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;cursor:grab;transition:all 0.2s ease;position:relative}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(17,20,24,.12)}
    .card.dragging{opacity:.6;transform:rotate(2deg)}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .status{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:16px;border:1px solid var(--border);font-size:12px;font-weight:600;background:#FAFBFC}
    .st-cleared{color:#333;background:#F2F3F5}.st-sub{color:#fff;background:var(--blue);border-color:transparent}.st-quo{color:#fff;background:var(--amber);border-color:transparent}.st-bnd{color:#fff;background:var(--green);border-color:transparent}
    .prio{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:16px;border:1px solid var(--border);font-size:12px;cursor:pointer;transition:all 0.2s ease}
    .prio:hover{transform:scale(1.05)}
    .prio.high{color:#fff;background:var(--brand)}.prio.med{color:#fff;background:#6B757E}.prio.low{color:#fff;background:#9E9E9E}
    
    /* Workbasket specific styles */
    .workbasket-mode .col[data-workbasket-stage="Send to UA"]{border-left:4px solid var(--blue)}
    .workbasket-mode .col[data-workbasket-stage="Send to Ops"]{border-left:4px solid var(--amber)}
    .workbasket-mode .col[data-workbasket-stage="Send to Sanctions"]{border-left:4px solid var(--brand)}
    
    .workbasket-mode .col .hd{background:linear-gradient(135deg,#f8f9fa,#e9ecef)}
    .workbasket-mode .col[data-workbasket-stage="Send to UA"] .hd{background:linear-gradient(135deg,#e3f2fd,#bbdefb)}
    .workbasket-mode .col[data-workbasket-stage="Send to Ops"] .hd{background:linear-gradient(135deg,#fff3e0,#ffe0b2)}
    .workbasket-mode .col[data-workbasket-stage="Send to Sanctions"] .hd{background:linear-gradient(135deg,#ffebee,#ffcdd2)}

    /* Advanced Panels */
    .filtersPanel, .bulkActionsPanel, .analyticsPanel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      padding: 20px;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .filtersGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .filterGroup {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filterGroup label {
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .filterGroup select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      color: var(--text);
    }

    .filterActions {
      display: flex;
      gap: 8px;
      align-items: end;
    }

    .bulkActionsContent {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .bulkInfo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bulkActions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .analyticsGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .analyticsCard {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }

    .analyticsCard h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .metricLabel {
      font-size: 12px;
      color: var(--muted);
    }

    .metricValue {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .metricValue.overdue {
      color: var(--brand);
    }

    /* Bulk selection styles */
    .card.selected {
      border-color: var(--brand);
      background: #ffe3e3;
    }

    .card .bulkCheckbox {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      accent-color: var(--brand);
    }

    .bulk-mode .card {
      padding-right: 32px;
    }

    /* Alert styles */
    .card.overdue {
      border-left: 4px solid var(--brand);
      background: #fff5f5;
    }

    .card.overdue .overdueAlert {
      display: block;
      background: var(--brand);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      margin-top: 8px;
    }

    .overdueAlert {
      display: none;
    }

    /* Auto-assignment rules panel */
    .rulesPanel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      padding: 20px;
    }

    .rulesList {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .ruleItem {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .ruleItem.active {
      border-color: var(--green);
      background: #f0f9f0;
    }

    .ruleItem.inactive {
      opacity: 0.6;
    }

    .ruleToggle {
      width: 40px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .ruleToggle.active {
      background: var(--green);
    }

    .ruleToggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .ruleToggle.active::after {
      transform: translateX(20px);
    }

    .ruleContent {
      flex: 1;
    }

    .ruleName {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .ruleDescription {
      font-size: 12px;
      color: var(--muted);
    }

    .ruleActions {
      display: flex;
      gap: 8px;
    }

    @media(max-width:1400px){.board{grid-template-columns:1fr 1fr}}
    @media(max-width:900px){.board{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header class="appbar">
  <div class="brand">
    <div class="logo" aria-label="Workbench">
      <svg viewBox="0 0 24 24"><path d="M12 2l7 3v6c0 5-3.5 8.4-7 9.9C8.5 19.4 5 16 5 11V5l7-3zM12 7a2.75 2.75 0 110 5.5A2.75 2.75 0 0112 7zm0 6.5c-2.8 0-5 1.6-5 3.5v1.2c1.7 1.1 3.5 2 5 2.6 1.5-.6 3.3-1.5 5-2.6V17c0-1.9-2.2-3.5-5-3.5z"/></svg>
    </div>
    <div><div style="font-size:12px;opacity:.9;letter-spacing:.18em;text-transform:uppercase">Underwriting Workbench</div><div class="title">Work Queue</div></div>
  </div>
  <div class="appnav">
    <button class="navbtn" onclick="location.href='index.html'">Home</button>
    <button class="navbtn primary" onclick="location.href='workqueue.html'">Work Queue</button>
    <button class="navbtn" onclick="location.href='dashboard.html'">Dashboard</button>
    <button class="navbtn" onclick="location.href='toolkit.html'">Toolkit</button>
  </div>
  <div class="profile"><div class="avatar">MN</div><div><div style="font-weight:700">Marin Nikolla</div><div style="font-size:12px;opacity:.85">Lead Underwriter</div></div></div>
</header>

<main class="wrap">
  <!-- Sticky search -->
  <div class="stickySearch" id="searchBar">
    <div class="searchInput">
      <svg class="icon" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35m1.6-4.9a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="q" placeholder="Search cards by client, broker, product, workbasket (Enter)"/>
    </div>
    <button class="btn2" onclick="toggleAdvancedFilters()">
      <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M3 17h6v-2H3v2zm0-6h6V9H3v2zm0-6h6V3H3v2zm10 0h8v2h-8V5zm0 6h8v2h-8v-2zm0 6h8v2h-8v-2z"/></svg>
      Filters
    </button>
    <button class="btn2" onclick="toggleBulkActions()" id="bulkToggle">
      <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H3V6h16v12z"/></svg>
      Bulk Actions
    </button>
    <button class="btn2" onclick="toggleAnalytics()">
      <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h2v-2H7v2zm0 4h2v-2H7v2zM7 7v2h2V7H7zm3.5 5.5l2.5-3L15 12h5v2h-5l-1.5 2-2.5-3z"/></svg>
      Analytics
    </button>
    <button class="btn2" onclick="toggleRules()">
      <svg class="icon" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      Rules
    </button>
    <button class="btn2 primary" id="workbasketToggle" onclick="toggleWorkbaskets()">
      <svg class="icon" viewBox="0 0 24 24" style="fill: #fff; width: 16px; height: 16px;"><path d="M19 7h-8v6h8V7zm-2 4h-4V9h4v2zm4-13H3C1.9 1 1 1.9 1 3v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H3V5h18v12z"/></svg>
      Workbaskets
    </button>
  </div>

  <!-- Advanced Filters Panel -->
  <div class="filtersPanel" id="filtersPanel" style="display:none">
    <div class="filtersGrid">
      <div class="filterGroup">
        <label>Priority</label>
        <select id="priorityFilter">
          <option value="">All Priorities</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
      <div class="filterGroup">
        <label>Channel</label>
        <select id="channelFilter">
          <option value="">All Channels</option>
          <option value="Broker">Broker</option>
          <option value="Direct">Direct</option>
          <option value="MGA">MGA</option>
        </select>
      </div>
      <div class="filterGroup">
        <label>Time in Stage</label>
        <select id="timeFilter">
          <option value="">Any Time</option>
          <option value="1h">Last Hour</option>
          <option value="1d">Last Day</option>
          <option value="3d">Last 3 Days</option>
          <option value="7d">Last Week</option>
          <option value="overdue">Overdue (>7 days)</option>
        </select>
      </div>
      <div class="filterGroup">
        <label>Premium Range</label>
        <select id="premiumFilter">
          <option value="">Any Amount</option>
          <option value="0-500k">$0 - $500K</option>
          <option value="500k-1m">$500K - $1M</option>
          <option value="1m-5m">$1M - $5M</option>
          <option value="5m+">$5M+</option>
        </select>
      </div>
      <div class="filterGroup">
        <label>Workbasket Stage</label>
        <select id="workbasketFilter">
          <option value="">All Workbaskets</option>
          <option value="Send to UA">Send to UA</option>
          <option value="Send to Ops">Send to Ops</option>
          <option value="Send to Sanctions">Send to Sanctions</option>
          <option value="none">No Workbasket</option>
        </select>
      </div>
      <div class="filterActions">
        <button class="btn2 primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn2" onclick="clearFilters()">Clear All</button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Panel -->
  <div class="bulkActionsPanel" id="bulkActionsPanel" style="display:none">
    <div class="bulkActionsContent">
      <div class="bulkInfo">
        <span id="selectedCount">0 selected</span>
        <button class="btn2 small" onclick="selectAll()">Select All</button>
        <button class="btn2 small" onclick="selectNone()">Select None</button>
      </div>
      <div class="bulkActions">
        <button class="btn2" onclick="bulkMoveToWorkbasket('Send to UA')">Move to UA</button>
        <button class="btn2" onclick="bulkMoveToWorkbasket('Send to Ops')">Move to Ops</button>
        <button class="btn2" onclick="bulkMoveToWorkbasket('Send to Sanctions')">Move to Sanctions</button>
        <button class="btn2" onclick="bulkRemoveFromWorkbasket()">Remove from Workbasket</button>
        <button class="btn2" onclick="bulkChangePriority()">Change Priority</button>
        <button class="btn2" onclick="bulkExport()">Export Selected</button>
      </div>
    </div>
  </div>

  <!-- Analytics Panel -->
  <div class="analyticsPanel" id="analyticsPanel" style="display:none">
    <div class="analyticsGrid">
      <div class="analyticsCard">
        <h3>Stage Analytics</h3>
        <div class="metric">
          <span class="metricLabel">Avg. Time in Stage:</span>
          <span class="metricValue" id="avgStageTime">2.3 days</span>
        </div>
        <div class="metric">
          <span class="metricLabel">Risks Overdue:</span>
          <span class="metricValue overdue" id="overdueCount">3</span>
        </div>
      </div>
      <div class="analyticsCard">
        <h3>Workbasket Analytics</h3>
        <div class="metric">
          <span class="metricLabel">UA Queue:</span>
          <span class="metricValue" id="uaCount">2</span>
        </div>
        <div class="metric">
          <span class="metricLabel">Ops Queue:</span>
          <span class="metricValue" id="opsCount">1</span>
        </div>
        <div class="metric">
          <span class="metricLabel">Sanctions Queue:</span>
          <span class="metricValue" id="sanctionsCount">1</span>
        </div>
      </div>
      <div class="analyticsCard">
        <h3>Throughput</h3>
        <div class="metric">
          <span class="metricLabel">Processed Today:</span>
          <span class="metricValue" id="processedToday">12</span>
        </div>
        <div class="metric">
          <span class="metricLabel">Completion Rate:</span>
          <span class="metricValue" id="completionRate">85%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Auto-Assignment Rules Panel -->
  <div class="rulesPanel" id="rulesPanel" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;font-size:18px;font-weight:700">Auto-Assignment Rules</h3>
      <button class="btn2 primary" onclick="addNewRule()">Add Rule</button>
    </div>
    <div class="rulesList" id="rulesList">
      <!-- Rules will be populated by JavaScript -->
    </div>
  </div>

  <!-- Kanban board -->
  <section class="board" id="board">
    <!-- columns injected -->
  </section>
</main>

<script>
const SEED=[
 {"id":"a0","insured":"Atlas Foods Group","broker":"Howden","lob":"Property","product":"Food & Bev Package","biz":"Renewal","eff":"2025-10-01","premium":190000,"stage":"Cleared","age":"5h","priority":"Medium","channel":"Broker","stageTimestamp":Date.now() - 5*60*60*1000,"workbasketStage":"Send to UA"},
 {"id":"a1","insured":"Orion AeroSystems","broker":"Crestline Broking","lob":"Property","product":"Aviation PAR","biz":"New","eff":"2025-11-01","premium":980000,"stage":"Quoted","age":"3d","priority":"High","channel":"Broker","stageTimestamp":Date.now() - 3*24*60*60*1000,"workbasketStage":"Send to Ops"},
 {"id":"a2","insured":"Hyperion Biotech","broker":"Apex Risk Partners","lob":"Specialty","product":"Life Science Liability","biz":"New","eff":"2025-12-12","premium":460000,"stage":"Submissions","age":"1d","priority":"Medium","channel":"Direct","stageTimestamp":Date.now() - 1*24*60*60*1000,"workbasketStage":"Send to Sanctions"},
 {"id":"a3","insured":"Neptune Offshore Wind","broker":"Westshore Willis","lob":"Marine","product":"Offshore Construction","biz":"Renewal","eff":"2025-12-31","premium":1875000,"stage":"Bound","age":"6h","priority":"High","channel":"Broker","stageTimestamp":Date.now() - 6*60*60*1000,"workbasketStage":null},
 {"id":"a4","insured":"Lumenova Data Centers","broker":"Cairnstone","lob":"Property","product":"NatCat Excess","biz":"Renewal","eff":"2025-10-30","premium":1320000,"stage":"Bound","age":"5d","priority":"High","channel":"Direct","stageTimestamp":Date.now() - 5*24*60*60*1000,"workbasketStage":null},
 {"id":"a5","insured":"Phoenix Rail & Freight","broker":"Gullwing Re","lob":"Casualty","product":"Excess Liability","biz":"New","eff":"2025-11-05","premium":720000,"stage":"Quoted","age":"4d","priority":"Medium","channel":"MGA","stageTimestamp":Date.now() - 4*24*60*60*1000,"workbasketStage":null},
 {"id":"a6","insured":"Vivid Motors EV","broker":"Aon Global","lob":"Specialty","product":"Tech E&O","biz":"New","eff":"2025-11-20","premium":540000,"stage":"Submissions","age":"1d","priority":"High","channel":"Broker","stageTimestamp":Date.now() - 1*24*60*60*1000,"workbasketStage":null},
 {"id":"a7","insured":"Evergreen Supermarkets","broker":"Lockton City","lob":"Property","product":"Retail Package","biz":"Renewal","eff":"2025-12-01","premium":310000,"stage":"Submissions","age":"7h","priority":"Medium","channel":"Direct","stageTimestamp":Date.now() - 7*60*60*1000,"workbasketStage":null},
 {"id":"a8","insured":"Silverline Hospitality","broker":"Marsh Europe","lob":"Property","product":"Hotels PAR","biz":"New","eff":"2025-10-12","premium":880000,"stage":"Quoted","age":"2d","priority":"High","channel":"Broker","stageTimestamp":Date.now() - 2*24*60*60*1000,"workbasketStage":null},
 {"id":"a9","insured":"NorthSea Energy","broker":"Aon Offshore","lob":"Marine","product":"Offshore Construction","biz":"Renewal","eff":"2025-12-31","premium":1750000,"stage":"Bound","age":"2d","priority":"High","channel":"Broker","stageTimestamp":Date.now() - 2*24*60*60*1000,"workbasketStage":null}
];
let ALL=[...SEED];
let workbasketMode = false;
let bulkMode = false;
let selectedRisks = new Set();
let currentFilters = {};

// Auto-assignment rules
let autoAssignmentRules = [
  {
    id: 'rule1',
    name: 'High Priority to UA',
    description: 'Automatically assign high priority risks to UA workbasket',
    active: true,
    conditions: { priority: 'High' },
    action: { workbasketStage: 'Send to UA' }
  },
  {
    id: 'rule2',
    name: 'Marine Risks to Ops',
    description: 'Assign marine risks to Ops workbasket',
    active: true,
    conditions: { lob: 'Marine' },
    action: { workbasketStage: 'Send to Ops' }
  },
  {
    id: 'rule3',
    name: 'Large Premiums to Sanctions',
    description: 'Assign risks with premium > $1M to Sanctions',
    active: false,
    conditions: { premiumMin: 1000000 },
    action: { workbasketStage: 'Send to Sanctions' }
  }
];

const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const statusClass=s=>s==='Cleared'?'st-cleared':s==='Submissions'?'st-sub':s==='Quoted'?'st-quo':'st-bnd';
const prioClass=p=>p==='High'?'high':p==='Low'?'low':'med';
const currency=n=>(+n).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});

const STAGES=['Cleared','Submissions','Quoted','Bound'];
const WORKBASKET_STAGES=['Send to UA','Send to Ops','Send to Sanctions'];

// Time formatting functions
function formatTimeAgo(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / (1000 * 60));
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days > 0) return `${days}d`;
  if (hours > 0) return `${hours}h`;
  if (minutes > 0) return `${minutes}m`;
  return 'now';
}

function getStageDuration(risk) {
  return formatTimeAgo(risk.stageTimestamp);
}

function renderBoard(){
  const stageChips=document.querySelector('.chip.active')?.dataset.stage||'';
  const q=($('#q').value||'').toLowerCase().trim();
  const rows=ALL.filter(r=>{
    const sOK=!stageChips || r.stage===stageChips;
    const qOK=!q || [r.insured,r.broker,r.product,r.lob,r.stage].join(' ').toLowerCase().includes(q);
    return sOK && qOK;
  });

  if (workbasketMode) {
    const byWorkbasketStage = Object.fromEntries(WORKBASKET_STAGES.map(s=>[s,[]]));
    rows.forEach(r=>{
      if (r.workbasketStage) {
        byWorkbasketStage[r.workbasketStage]?.push(r);
      }
    });

    $('#board').innerHTML = WORKBASKET_STAGES.map(s=>`
      <div class="col" data-workbasket-stage="${s}">
        <div class="hd"><strong>${s}</strong><span style="font-size:12px;color:#6B757E">${byWorkbasketStage[s].length}</span></div>
        <div class="bucket" ondragover="event.preventDefault()" ondrop="onWorkbasketDrop(event,'${s}')">
          ${byWorkbasketStage[s].map(c=>cardHTML(c, true)).join('')}
        </div>
      </div>`).join('');
  } else {
  const byStage = Object.fromEntries(STAGES.map(s=>[s,[]]));
  rows.forEach(r=>byStage[r.stage]?.push(r));

  $('#board').innerHTML = STAGES.map(s=>`
    <div class="col" data-stage="${s}">
      <div class="hd"><strong>${s}</strong><span style="font-size:12px;color:#6B757E">${byStage[s].length}</span></div>
      <div class="bucket" ondragover="event.preventDefault()" ondrop="onDrop(event,'${s}')">
          ${byStage[s].map(c=>cardHTML(c, false)).join('')}
      </div>
    </div>`).join('');
  }

  // attach drag events
  $$('.card').forEach(el=>{
    el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',el.dataset.id); });
    el.addEventListener('dragend',()=>el.classList.remove('dragging'));
  });
}

function cardHTML(r, isWorkbasket = false){
  const stageDuration = getStageDuration(r);
  const isOverdue = isRiskOverdue(r);
  const isSelected = selectedRisks.has(r.id);
  const overdueAlert = isOverdue ? '<div class="overdueAlert">OVERDUE</div>' : '';
  
  return `<div class="card ${isOverdue ? 'overdue' : ''} ${isSelected ? 'selected' : ''}" draggable="true" data-id="${r.id}" onclick="openRisk('${r.id}')">
    ${bulkMode ? `<input type="checkbox" class="bulkCheckbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection('${r.id}')">` : ''}
    <div class="meta">
      <span class="status ${statusClass(r.stage)}">${r.stage}</span>
      <select class="prio ${prioClass(r.priority)}" onclick="event.stopPropagation()" onchange="changePriority('${r.id}', this.value)">
        <option value="High" ${r.priority === 'High' ? 'selected' : ''}>High</option>
        <option value="Medium" ${r.priority === 'Medium' ? 'selected' : ''}>Medium</option>
        <option value="Low" ${r.priority === 'Low' ? 'selected' : ''}>Low</option>
      </select>
    </div>
    <div style="font-weight:700;font-size:16px;margin-bottom:8px;line-height:1.3">${r.insured}</div>
    <div style="color:#6B757E;font-size:13px;margin-bottom:8px">${r.product} • ${r.lob}</div>
    <div style="font-size:12px;color:#6B757E;margin-bottom:12px">${currency(r.premium)} • ${r.broker}</div>
    <div style="padding:8px 12px;background:#f8f9fa;border-radius:8px;font-size:12px;color:#6B757E;border-left:3px solid var(--brand)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span>In ${isWorkbasket ? (r.workbasketStage || 'No Workbasket') : r.stage}</span>
        <span style="font-weight:600;color:var(--brand)">${stageDuration}</span>
      </div>
    </div>
    ${overdueAlert}
  </div>`;
}
function openRisk(id){ location.href='risk.html?id='+encodeURIComponent(id); }

function onDrop(e,stage){
  const id=e.dataTransfer.getData('text/plain');
  ALL=ALL.map(r=>r.id===id?{...r,stage,stageTimestamp:Date.now()}:r);
  renderBoard();
}

function onWorkbasketDrop(e,workbasketStage){
  const id=e.dataTransfer.getData('text/plain');
  ALL=ALL.map(r=>r.id===id?{...r,workbasketStage,workbasketTimestamp:Date.now()}:r);
  renderBoard();
}

function toggleWorkbaskets(){
  workbasketMode = !workbasketMode;
  const toggleBtn = $('#workbasketToggle');
  
  if (workbasketMode) {
    document.body.classList.add('workbasket-mode');
    toggleBtn.innerHTML = `
      <svg class="icon" viewBox="0 0 24 24" style="fill: #fff; width: 16px; height: 16px;"><path d="M19 7h-8v6h8V7zm-2 4h-4V9h4v2zm4-13H3C1.9 1 1 1.9 1 3v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H3V5h18v12z"/></svg>
      Normal View
    `;
    toggleBtn.style.background = 'linear-gradient(180deg,var(--green),#2E7D32)';
  } else {
    document.body.classList.remove('workbasket-mode');
    toggleBtn.innerHTML = `
      <svg class="icon" viewBox="0 0 24 24" style="fill: #fff; width: 16px; height: 16px;"><path d="M19 7h-8v6h8V7zm-2 4h-4V9h4v2zm4-13H3C1.9 1 1 1.9 1 3v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H3V5h18v12z"/></svg>
      Workbaskets
    `;
    toggleBtn.style.background = 'linear-gradient(180deg,var(--brand-2),var(--brand))';
  }
  
  renderBoard();
}

// Helper functions
function isRiskOverdue(risk) {
  const now = Date.now();
  const timeInStage = now - risk.stageTimestamp;
  const sevenDays = 7 * 24 * 60 * 60 * 1000;
  return timeInStage > sevenDays;
}

function applyAutoAssignmentRules() {
  ALL.forEach(risk => {
    if (!risk.workbasketStage) {
      autoAssignmentRules.forEach(rule => {
        if (rule.active && matchesRule(risk, rule.conditions)) {
          risk.workbasketStage = rule.action.workbasketStage;
          risk.workbasketTimestamp = Date.now();
        }
      });
    }
  });
}

function matchesRule(risk, conditions) {
  for (const [key, value] of Object.entries(conditions)) {
    if (key === 'premiumMin' && risk.premium < value) return false;
    if (key !== 'premiumMin' && risk[key] !== value) return false;
  }
  return true;
}

function updateAnalytics() {
  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000;
  
  // Calculate average time in stage
  const totalTime = ALL.reduce((sum, risk) => sum + (now - risk.stageTimestamp), 0);
  const avgTime = totalTime / ALL.length / oneDay;
  $('#avgStageTime').textContent = avgTime.toFixed(1) + ' days';
  
  // Count overdue risks
  const overdueCount = ALL.filter(isRiskOverdue).length;
  $('#overdueCount').textContent = overdueCount;
  
  // Count workbasket queues
  $('#uaCount').textContent = ALL.filter(r => r.workbasketStage === 'Send to UA').length;
  $('#opsCount').textContent = ALL.filter(r => r.workbasketStage === 'Send to Ops').length;
  $('#sanctionsCount').textContent = ALL.filter(r => r.workbasketStage === 'Send to Sanctions').length;
  
  // Calculate throughput (mock data for demo)
  $('#processedToday').textContent = Math.floor(Math.random() * 20) + 5;
  $('#completionRate').textContent = (85 + Math.floor(Math.random() * 15)) + '%';
}

// Panel toggle functions
function toggleAdvancedFilters() {
  const panel = $('#filtersPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function toggleBulkActions() {
  bulkMode = !bulkMode;
  const panel = $('#bulkActionsPanel');
  const toggle = $('#bulkToggle');
  
  if (bulkMode) {
    panel.style.display = 'block';
    toggle.style.background = 'linear-gradient(180deg,var(--green),#2E7D32)';
    toggle.style.color = '#fff';
    document.body.classList.add('bulk-mode');
  } else {
    panel.style.display = 'none';
    toggle.style.background = '';
    toggle.style.color = '';
    document.body.classList.remove('bulk-mode');
    selectedRisks.clear();
  }
  
  renderBoard();
}

function toggleAnalytics() {
  const panel = $('#analyticsPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display === 'block') {
    updateAnalytics();
  }
}

function toggleRules() {
  const panel = $('#rulesPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  if (panel.style.display === 'block') {
    renderRules();
  }
}

// Filter functions
function applyFilters() {
  currentFilters = {
    priority: $('#priorityFilter').value,
    channel: $('#channelFilter').value,
    time: $('#timeFilter').value,
    premium: $('#premiumFilter').value,
    workbasket: $('#workbasketFilter').value
  };
  renderBoard();
}

function clearFilters() {
  $('#priorityFilter').value = '';
  $('#channelFilter').value = '';
  $('#timeFilter').value = '';
  $('#premiumFilter').value = '';
  $('#workbasketFilter').value = '';
  currentFilters = {};
  renderBoard();
}

// Bulk action functions
function toggleSelection(id) {
  if (selectedRisks.has(id)) {
    selectedRisks.delete(id);
  } else {
    selectedRisks.add(id);
  }
  updateSelectedCount();
  renderBoard();
}

function selectAll() {
  const visibleRisks = getVisibleRisks();
  visibleRisks.forEach(risk => selectedRisks.add(risk.id));
  updateSelectedCount();
  renderBoard();
}

function selectNone() {
  selectedRisks.clear();
  updateSelectedCount();
  renderBoard();
}

function updateSelectedCount() {
  $('#selectedCount').textContent = `${selectedRisks.size} selected`;
}

function getVisibleRisks() {
  const q=($('#q').value||'').toLowerCase().trim();
  
  return ALL.filter(r=>{
    const qOK=!q || [r.insured,r.broker,r.product,r.lob,r.stage,r.workbasketStage].join(' ').toLowerCase().includes(q);
    
    // Apply advanced filters
    const priorityOK = !currentFilters.priority || r.priority === currentFilters.priority;
    const channelOK = !currentFilters.channel || r.channel === currentFilters.channel;
    const workbasketOK = !currentFilters.workbasket || 
      (currentFilters.workbasket === 'none' ? !r.workbasketStage : r.workbasketStage === currentFilters.workbasket);
    
    let timeOK = true;
    if (currentFilters.time) {
      const now = Date.now();
      const timeInStage = now - r.stageTimestamp;
      const oneHour = 60 * 60 * 1000;
      const oneDay = 24 * oneHour;
      
      switch (currentFilters.time) {
        case '1h': timeOK = timeInStage < oneHour; break;
        case '1d': timeOK = timeInStage < oneDay; break;
        case '3d': timeOK = timeInStage < 3 * oneDay; break;
        case '7d': timeOK = timeInStage < 7 * oneDay; break;
        case 'overdue': timeOK = timeInStage > 7 * oneDay; break;
      }
    }
    
    let premiumOK = true;
    if (currentFilters.premium) {
      switch (currentFilters.premium) {
        case '0-500k': premiumOK = r.premium <= 500000; break;
        case '500k-1m': premiumOK = r.premium > 500000 && r.premium <= 1000000; break;
        case '1m-5m': premiumOK = r.premium > 1000000 && r.premium <= 5000000; break;
        case '5m+': premiumOK = r.premium > 5000000; break;
      }
    }
    
    return qOK && priorityOK && channelOK && workbasketOK && timeOK && premiumOK;
  });
}

function bulkMoveToWorkbasket(workbasketStage) {
  selectedRisks.forEach(id => {
    ALL = ALL.map(r => r.id === id ? {...r, workbasketStage, workbasketTimestamp: Date.now()} : r);
  });
  selectedRisks.clear();
  updateSelectedCount();
  renderBoard();
}

function bulkRemoveFromWorkbasket() {
  selectedRisks.forEach(id => {
    ALL = ALL.map(r => r.id === id ? {...r, workbasketStage: null, workbasketTimestamp: null} : r);
  });
  selectedRisks.clear();
  updateSelectedCount();
  renderBoard();
}

function changePriority(id, newPriority) {
  ALL = ALL.map(r => r.id === id ? {...r, priority: newPriority} : r);
  renderBoard();
}

function bulkChangePriority() {
  const newPriority = prompt('Enter new priority (High/Medium/Low):');
  if (newPriority && ['High', 'Medium', 'Low'].includes(newPriority)) {
    selectedRisks.forEach(id => {
      ALL = ALL.map(r => r.id === id ? {...r, priority: newPriority} : r);
    });
    selectedRisks.clear();
    updateSelectedCount();
    renderBoard();
  }
}

function bulkExport() {
  const selectedData = ALL.filter(r => selectedRisks.has(r.id));
  const csv = convertToCSV(selectedData);
  downloadCSV(csv, 'selected_risks.csv');
}

function convertToCSV(data) {
  const headers = ['ID', 'Insured', 'Broker', 'Product', 'LOB', 'Stage', 'Priority', 'Premium', 'Channel'];
  const rows = data.map(r => [r.id, r.insured, r.broker, r.product, r.lob, r.stage, r.priority, r.premium, r.channel]);
  return [headers, ...rows].map(row => row.join(',')).join('\n');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  window.URL.revokeObjectURL(url);
}

// Rules management functions
function renderRules() {
  const rulesList = $('#rulesList');
  rulesList.innerHTML = autoAssignmentRules.map(rule => `
    <div class="ruleItem ${rule.active ? 'active' : 'inactive'}">
      <div class="ruleToggle ${rule.active ? 'active' : ''}" onclick="toggleRule('${rule.id}')"></div>
      <div class="ruleContent">
        <div class="ruleName">${rule.name}</div>
        <div class="ruleDescription">${rule.description}</div>
      </div>
      <div class="ruleActions">
        <button class="btn2 small" onclick="editRule('${rule.id}')">Edit</button>
        <button class="btn2 small" onclick="deleteRule('${rule.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

function toggleRule(ruleId) {
  const rule = autoAssignmentRules.find(r => r.id === ruleId);
  if (rule) {
    rule.active = !rule.active;
    renderRules();
    applyAutoAssignmentRules();
    renderBoard();
  }
}

function addNewRule() {
  const name = prompt('Rule name:');
  const description = prompt('Rule description:');
  const conditions = prompt('Conditions (JSON format):');
  const action = prompt('Action (JSON format):');
  
  if (name && description && conditions && action) {
    try {
      const newRule = {
        id: 'rule' + Date.now(),
        name,
        description,
        active: true,
        conditions: JSON.parse(conditions),
        action: JSON.parse(action)
      };
      autoAssignmentRules.push(newRule);
      renderRules();
    } catch (e) {
      alert('Invalid JSON format');
    }
  }
}

function editRule(ruleId) {
  const rule = autoAssignmentRules.find(r => r.id === ruleId);
  if (rule) {
    const newName = prompt('Rule name:', rule.name);
    const newDescription = prompt('Rule description:', rule.description);
    if (newName && newDescription) {
      rule.name = newName;
      rule.description = newDescription;
      renderRules();
    }
  }
}

function deleteRule(ruleId) {
  if (confirm('Are you sure you want to delete this rule?')) {
    autoAssignmentRules = autoAssignmentRules.filter(r => r.id !== ruleId);
    renderRules();
  }
}

// Enhanced renderBoard function with filtering
function renderBoardWithFilters() {
  const q=($('#q').value||'').toLowerCase().trim();
  
  let rows=ALL.filter(r=>{
    const qOK=!q || [r.insured,r.broker,r.product,r.lob,r.stage,r.workbasketStage].join(' ').toLowerCase().includes(q);
    
    // Apply advanced filters
    const priorityOK = !currentFilters.priority || r.priority === currentFilters.priority;
    const channelOK = !currentFilters.channel || r.channel === currentFilters.channel;
    const workbasketOK = !currentFilters.workbasket || 
      (currentFilters.workbasket === 'none' ? !r.workbasketStage : r.workbasketStage === currentFilters.workbasket);
    
    let timeOK = true;
    if (currentFilters.time) {
      const now = Date.now();
      const timeInStage = now - r.stageTimestamp;
      const oneHour = 60 * 60 * 1000;
      const oneDay = 24 * oneHour;
      
      switch (currentFilters.time) {
        case '1h': timeOK = timeInStage < oneHour; break;
        case '1d': timeOK = timeInStage < oneDay; break;
        case '3d': timeOK = timeInStage < 3 * oneDay; break;
        case '7d': timeOK = timeInStage < 7 * oneDay; break;
        case 'overdue': timeOK = timeInStage > 7 * oneDay; break;
      }
    }
    
    let premiumOK = true;
    if (currentFilters.premium) {
      switch (currentFilters.premium) {
        case '0-500k': premiumOK = r.premium <= 500000; break;
        case '500k-1m': premiumOK = r.premium > 500000 && r.premium <= 1000000; break;
        case '1m-5m': premiumOK = r.premium > 1000000 && r.premium <= 5000000; break;
        case '5m+': premiumOK = r.premium > 5000000; break;
      }
    }
    
    return qOK && priorityOK && channelOK && workbasketOK && timeOK && premiumOK;
  });

  if (workbasketMode) {
    const byWorkbasketStage = Object.fromEntries(WORKBASKET_STAGES.map(s=>[s,[]]));
    rows.forEach(r=>{
      if (r.workbasketStage) {
        byWorkbasketStage[r.workbasketStage]?.push(r);
      }
    });

    $('#board').innerHTML = WORKBASKET_STAGES.map(s=>`
      <div class="col" data-workbasket-stage="${s}">
        <div class="hd"><strong>${s}</strong><span style="font-size:12px;color:#6B757E">${byWorkbasketStage[s].length}</span></div>
        <div class="bucket" ondragover="event.preventDefault()" ondrop="onWorkbasketDrop(event,'${s}')">
          ${byWorkbasketStage[s].map(c=>cardHTML(c, true)).join('')}
        </div>
      </div>`).join('');
  } else {
    const byStage = Object.fromEntries(STAGES.map(s=>[s,[]]));
    rows.forEach(r=>byStage[r.stage]?.push(r));

    $('#board').innerHTML = STAGES.map(s=>`
      <div class="col" data-stage="${s}">
        <div class="hd"><strong>${s}</strong><span style="font-size:12px;color:#6B757E">${byStage[s].length}</span></div>
        <div class="bucket" ondragover="event.preventDefault()" ondrop="onDrop(event,'${s}')">
          ${byStage[s].map(c=>cardHTML(c, false)).join('')}
        </div>
      </div>`).join('');
  }

  // attach drag events
  $$('.card').forEach(el=>{
    el.addEventListener('dragstart',e=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain',el.dataset.id); });
    el.addEventListener('dragend',()=>el.classList.remove('dragging'));
  });
}

// Override the original renderBoard function
const originalRenderBoard = renderBoard;
renderBoard = renderBoardWithFilters;

// Search functionality
$('#q').addEventListener('keydown',e=>{ if(e.key==='Enter') renderBoard(); });
$('#q').addEventListener('input',()=>{ renderBoard(); });
// Frosted
window.addEventListener('scroll',()=>{ if(window.scrollY>8) $('#searchBar').classList.add('frosted'); else $('#searchBar').classList.remove('frosted'); });

// Initialize
applyAutoAssignmentRules();
renderBoard();
</script>
</body>
</html>
