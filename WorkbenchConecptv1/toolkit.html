<!DOCTYPE html>
<html lang="en">
<head>
  <title>Underwriting Workbench — Toolkit</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#6F1111; --brand-2:#7A1414;
      --ink:#0F1216; --text:#2A2F33; --muted:#6B757E;
      --bg:#F6F7F9; --surface:#fff; --border:#E6E9EE;
      --shadow:0 10px 30px rgba(17,20,24,.06),0 2px 8px rgba(17,20,24,.04);
      --green:#2E7D32; --amber:#FB8C00; --blue:#1976D2; --purple:#7C3AED; --grey:#667085;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
    a{color:inherit;text-decoration:none}

    /* App bar */
    .appbar{position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:280px 1fr auto;gap:16px;align-items:center;
      padding:14px 20px;background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#fff,rgba(255,255,255,.9));display:grid;place-items:center}
    .logo svg{width:22px;height:22px;fill:var(--brand)}
    .title{font-weight:800}
    .appnav{display:flex;gap:8px}
    .navbtn{border:none;background:rgba(255,255,255,.14);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .navbtn.primary{background:#fff;color:var(--brand)}
    .profile{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.24);border-radius:999px;padding:6px 10px 6px 6px}
    .avatar{width:34px;height:34px;border-radius:999px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}

    .wrap{max-width:1680px;margin:0 auto;padding:22px;display:grid;gap:16px}
    .tabs{display:flex;gap:8px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:transparent;color:#fff}

    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .hd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .bd{padding:14px 16px}

    .grid{display:grid;grid-template-columns:1.25fr 1fr;gap:16px}
    .stack{display:grid;gap:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn2{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
    .btn2.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:transparent;color:#fff}
    .btn2.small{padding:6px 10px}
    .input{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#fff}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#6B757E}

    .templateCard{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;display:grid;gap:6px;cursor:pointer}
    .templateCard:hover{box-shadow:0 3px 10px rgba(17,20,24,.08)}
    .list{display:grid;gap:10px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(16,18,24,.45);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal .panel{width:min(980px,92vw);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .chart{width:100%;height:220px}
    .bar{height:10px;border-radius:8px;background:#EEF0F3;position:relative;overflow:hidden;border:1px solid var(--border)}
    .bar > span{position:absolute;left:0;top:0;bottom:0;border-radius:8px}
    .b-acc{background:#2E7D32}.b-ref{background:#7C3AED}.b-dec{background:#7A1414}

    @media(max-width:1200px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header class="appbar">
  <div class="brand">
    <div class="logo"><svg viewBox="0 0 24 24"><path d="M12 2l7 3v6c0 5-3.5 8.4-7 9.9C8.5 19.4 5 16 5 11V5l7-3zM12 7a2.75 2.75 0 110 5.5A2.75 2.75 0 0112 7zm0 6.5c-2.8 0-5 1.6-5 3.5v1.2c1.7 1.1 3.5 2 5 2.6 1.5-.6 3.3-1.5 5-2.6V17c0-1.9-2.2-3.5-5-3.5z"/></svg></div>
    <div><div style="font-size:12px;opacity:.9;letter-spacing:.18em;text-transform:uppercase">Underwriting Workbench</div><div class="title">Toolkit</div></div>
  </div>
  <div class="appnav">
    <button class="navbtn" onclick="location.href='index.html'">Home</button>
    <button class="navbtn" onclick="location.href='workqueue.html'">Work Queue</button>
    <button class="navbtn" onclick="location.href='dashboard.html'">Dashboard</button>
    <button class="navbtn primary" onclick="location.href='toolkit.html'">Toolkit</button>
  </div>
  <div class="profile"><div class="avatar">MN</div><div><div style="font-weight:700">Marin Nikolla</div><div style="font-size:12px;opacity:.85">Lead Underwriter</div></div></div>
</header>

<main class="wrap">
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" id="tab-appetite">Appetite Builder</button>
    <button class="tab" id="tab-wordings">Wordings Creator & Picker</button>
  </div>

  <!-- Appetite Builder PAGE -->
  <section id="page-appetite" class="grid">
    <!-- LEFT: Builder -->
    <div class="stack">
      <section class="card">
        <div class="hd">
          <strong>Build Business Rules</strong>
          <div class="row">
            <button class="btn2" onclick="clearRuleForm()">Clear</button>
            <button class="btn2 primary" onclick="addRule()">Add Rule</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <select id="a_field" class="input">
              <option value="LOB">LOB</option>
              <option value="Geography">Geography</option>
              <option value="TIV">TIV (USD)</option>
              <option value="Construction">Construction</option>
              <option value="Sprinklered">Sprinklered</option>
              <option value="Occupancy">Occupancy</option>
              <option value="NatCatZone">NatCat Zone</option>
              <option value="LossRatio">Loss Ratio (%)</option>
              <option value="BrokerTier">Broker Tier</option>
              <option value="DistanceToCoast">Distance to Coast (km)</option>
              <option value="YearBuilt">Year Built</option>
            </select>
            <select id="a_op" class="input">
              <option value="is">is</option>
              <option value="in">in</option>
              <option value=">=">&ge;</option>
              <option value="<=">&le;</option>
              <option value="between">between</option>
              <option value="contains">contains</option>
              <option value="!=">is not</option>
            </select>
            <input id="a_val" class="input" placeholder="Value (comma list or 'x..y' for between)"/>
            <select id="a_outcome" class="input">
              <option value="Accept">Accept</option>
              <option value="Refer">Refer</option>
              <option value="Decline">Decline</option>
            </select>
            <input id="a_rationale" class="input" placeholder="Rationale / commentary"/>
          </div>

          <div style="margin-top:10px">
            <div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Rule preview</div>
            <div id="a_dsl" class="badge" style="margin-top:6px">IF … THEN …</div>
          </div>

          <div style="margin-top:12px">
            <div class="muted" style="text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px">Current Rule Set</div>
            <table id="a_rules_tbl"><thead><tr>
              <th>#</th><th>When</th><th>Outcome</th><th>Rationale</th><th></th>
            </tr></thead><tbody></tbody></table>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn2" onclick="previewImpact(A_RULES)">Preview Impact (last year)</button>
          </div>
        </div>
      </section>

      <!-- Standard Library -->
      <section class="card">
        <div class="hd"><strong>Standard Appetite Library</strong>
          <input id="lib_q" class="input" placeholder="Search library…" oninput="renderLibrary()"/>
        </div>
        <div class="bd">
          <div id="lib_list" class="list"></div>
        </div>
      </section>
    </div>

    <!-- RIGHT: Save & Templates -->
    <div class="stack">
      <section class="card">
        <div class="hd">
          <strong>Save as Template</strong>
          <div class="row">
            <button class="btn2" onclick="referTemplate()">Refer to Team</button>
            <button class="btn2 primary" onclick="saveAppetiteTemplate()">Save Template</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <input id="a_tpl_name" class="input" placeholder="Template name (e.g., Property Core v1)"/>
            <input id="a_tpl_desc" class="input" placeholder="Short description"/>
          </div>
          <div style="margin-top:10px">
            <div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Refer to</div>
            <div class="row" style="margin-top:6px">
              <label class="badge"><input type="checkbox" id="a_ref_mn" checked> Marin Nikolla</label>
              <label class="badge"><input type="checkbox" id="a_ref_am"> Alex Morgan</label>
              <label class="badge"><input type="checkbox" id="a_ref_pr"> Priya Rao</label>
              <label class="badge"><input type="checkbox" id="a_ref_bt"> Ben Turner</label>
            </div>
            <textarea id="a_ref_note" rows="3" class="input" placeholder="Commentary / rationale for the team…"></textarea>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><strong>My Templates</strong></div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <input id="a_tpl_search" class="input" placeholder="Search templates…" oninput="renderAppetiteTemplates()"/>
            <select id="a_tpl_status" class="input" onchange="renderAppetiteTemplates()">
              <option value="">All statuses</option><option>Draft</option><option>In Review</option><option>Approved</option>
            </select>
          </div>
          <div id="a_tpl_list" class="list"></div>
        </div>
      </section>
    </div>
  </section>

  <!-- Wordings PAGE (unchanged from last version) -->
  <section id="page-wordings" class="grid" style="display:none">
    <div class="stack">
      <section class="card">
        <div class="hd"><strong>Wordings Catalog</strong>
          <div class="row"><button class="btn2" onclick="clearWFilters()">Clear</button></div>
        </div>
        <div class="bd">
          <div class="row">
            <input id="w_q" class="input" placeholder="Search text, code, tags…" onkeydown="if(event.key==='Enter') renderWordings()"/>
            <select id="w_lob" class="input" onchange="renderWordings()">
              <option value="">LOB: All</option><option>Property</option><option>Casualty</option><option>Marine</option><option>Specialty</option>
            </select>
            <select id="w_cat" class="input" onchange="renderWordings()">
              <option value="">Category: All</option><option>Condition</option><option>Exclusion</option><option>Definition</option><option>Endorsement</option>
            </select>
            <select id="w_status" class="input" onchange="renderWordings()">
              <option value="">Status: All</option><option>Approved</option><option>Pending</option><option>Draft</option>
            </select>
          </div>
          <div style="margin-top:10px;overflow:auto">
            <table id="w_tbl"><thead><tr>
              <th>Code</th><th>Title</th><th>LOB</th><th>Category</th><th>Status</th><th>Tags</th><th>Submitted</th><th></th>
            </tr></thead><tbody></tbody></table>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><strong>Editor</strong>
          <div class="row">
            <button class="btn2" onclick="wResetEditor()">Reset</button>
            <button class="btn2 primary" onclick="wSaveEdit()">Save Draft</button>
            <button class="btn2" onclick="wSendForApproval()">Send to Legal</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <input id="w_edit_code" class="input" placeholder="Code (e.g., LMA1234)"/>
            <input id="w_edit_title" class="input" placeholder="Title"/>
            <select id="w_edit_lob" class="input"><option>Property</option><option>Casualty</option><option>Marine</option><option>Specialty</option></select>
            <select id="w_edit_cat" class="input"><option>Condition</option><option>Exclusion</option><option>Definition</option><option>Endorsement</option></select>
          </div>
          <textarea id="w_edit_text" rows="8" class="input" placeholder="Clause text…"></textarea>
          <div class="row"><input id="w_edit_tags" class="input" placeholder="Tags (comma-separated)"/></div>
        </div>
      </section>
    </div>

    <div class="stack">
      <section class="card">
        <div class="hd"><strong>Template Composer</strong>
          <div class="row">
            <button class="btn2" onclick="wClearComposer()">Clear</button>
            <button class="btn2 primary" onclick="wSaveTemplate()">Save Template</button>
          </div>
        </div>
        <div class="bd">
          <input id="w_tpl_name" class="input" placeholder="Template name (e.g., PAR Base v1)"/>
          <div class="muted" style="margin-top:6px">Selected clauses</div>
          <div id="w_compose" class="list muted">No clauses added yet.</div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><strong>Wording Templates</strong></div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <input id="w_tpl_q" class="input" placeholder="Search templates…" oninput="renderWTemplates()"/>
            <select id="w_tpl_status" class="input" onchange="renderWTemplates()"><option value="">All</option><option>Approved</option><option>Pending</option><option>Draft</option></select>
          </div>
          <div id="w_tpl_list" class="list"></div>
        </div>
      </section>
    </div>
  </section>
</main>

<!-- Appetite Template Detail Modal -->
<div id="tplModal" class="modal">
  <div class="panel">
    <div class="hd">
      <strong id="tplTitle">Template</strong>
      <div class="row">
        <button class="btn2" onclick="tplLoadToBuilder()">Load into Builder</button>
        <button class="btn2" onclick="toggleTpl(false)">Close</button>
      </div>
    </div>
    <div class="bd">
      <div class="muted" id="tplDesc" style="margin-bottom:8px">—</div>

      <div style="display:grid;grid-template-columns:1.1fr .9fr;gap:16px">
        <div>
          <div class="muted" style="text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px">Rules</div>
          <div id="tplRules" class="list"></div>
        </div>
        <div>
          <div class="muted" style="text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px">Impact Preview (last year)</div>
          <div id="tplImpact">
            <div class="bar"><span id="barAcc" class="b-acc" style="width:0%"></span></div>
            <div style="display:flex;gap:8px;margin:6px 0">
              <span class="badge" id="accCount">Accept: 0</span>
              <span class="badge" id="refCount">Refer: 0</span>
              <span class="badge" id="decCount">Decline: 0</span>
            </div>
            <div class="muted" style="margin-top:8px">Top triggers</div>
            <div id="tplTriggers" class="list"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ===== Tabs ===== */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
$('#tab-appetite').onclick=()=>setTab('appetite');
$('#tab-wordings').onclick=()=>setTab('wordings');
function setTab(t){
  $$('.tab').forEach(x=>x.classList.remove('active'));
  $(`#tab-${t}`).classList.add('active');
  $('#page-appetite').style.display = t==='appetite'?'grid':'none';
  $('#page-wordings').style.display = t==='wordings'?'grid':'none';
}

/* ========= Appetite Builder ========= */
let A_RULES=[];  // working rule set
let A_TEMPLATES=[ // user templates
  {id:'at1', name:'Property Core v1', desc:'UK retail, core hazard', status:'Draft', refs:['Marin Nikolla'], note:'Aligns to 2025 capacity', rules:[
    {field:'LOB',op:'is',val:'Property',outcome:'Accept',rationale:'In-core'},
    {field:'TIV',op:'<=',val:'250000000',outcome:'Accept',rationale:'Cap line size'},
    {field:'Sprinklered',op:'is',val:'true',outcome:'Accept',rationale:'HPR standard'},
    {field:'NatCatZone',op:'!=',val:'A',outcome:'Refer',rationale:'Flood referral'}
  ]}
];

/* --- Standard Library (insurance-style) --- */
const LIBRARY=[
  {id:'lib_prop_hpr', name:'Property Core (HPR)',
    desc:'Sprinklered, non-combustible construction, TIV ≤ $250M, outside Flood Zone A.',
    rules:[
      {field:'LOB',op:'is',val:'Property',outcome:'Accept',rationale:'Property in scope'},
      {field:'Construction',op:'in',val:'Masonry,Non-Combustible,Fire Resistive',outcome:'Accept',rationale:'Preferred construction'},
      {field:'Sprinklered',op:'is',val:'true',outcome:'Accept',rationale:'HPR requirement'},
      {field:'TIV',op:'<=',val:'250000000',outcome:'Accept',rationale:'Capacity guardrail'},
      {field:'NatCatZone',op:'!=',val:'A',outcome:'Refer',rationale:'Flood referral'}
    ]},
  {id:'lib_car_core', name:'Construction All Risks — Core',
    desc:'New build, frame ≤ 3 floors unless fire resistive; TIV ≤ $150M.',
    rules:[
      {field:'LOB',op:'is',val:'Property',outcome:'Accept',rationale:'PAR scope'},
      {field:'Occupancy',op:'contains',val:'Construction',outcome:'Accept',rationale:'Construction projects'},
      {field:'TIV',op:'<=',val:'150000000',outcome:'Accept',rationale:'Limit manage'},
      {field:'Construction',op:'contains',val:'Frame',outcome:'Refer',rationale:'Higher combustibility unless FR'}
    ]},
  {id:'lib_cas_core', name:'Casualty Core',
    desc:'Products/GL with Loss Ratio < 60%, no US exports > 20%.',
    rules:[
      {field:'LOB',op:'is',val:'Casualty',outcome:'Accept',rationale:'Casualty scope'},
      {field:'LossRatio',op:'<',val:'60',outcome:'Accept',rationale:'Healthy results'},
      {field:'Occupancy',op:'contains',val:'Chemical',outcome:'Refer',rationale:'Process safety review'}
    ]},
  {id:'lib_energy_off', name:'Energy Offshore',
    desc:'Offshore construction — always refer; Decline if NatCat Zone A & DistanceToCoast < 2km.',
    rules:[
      {field:'LOB',op:'is',val:'Marine',outcome:'Refer',rationale:'Offshore needs specialist review'},
      {field:'NatCatZone',op:'is',val:'A',outcome:'Refer',rationale:'Flood exposure'},
      {field:'DistanceToCoast',op:'<',val:'2',outcome:'Decline',rationale:'Too near shore in Zone A'}
    ]},
  {id:'lib_life_sci', name:'Life Science Liability',
    desc:'Accept CE/FDA Class I–II; Refer Class III; Decline if LossRatio ≥ 80%.',
    rules:[
      {field:'LOB',op:'is',val:'Specialty',outcome:'Accept',rationale:'Life science scope'},
      {field:'Occupancy',op:'contains',val:'Medical Device',outcome:'Refer',rationale:'Device class review'},
      {field:'LossRatio',op:'>=',val:'80',outcome:'Decline',rationale:'Adverse performance'}
    ]}
];

/* Last year submissions (impact preview dataset) */
const LAST_YEAR = [
  {id:'s1',  LOB:'Property', Geography:'UK', TIV:120000000, Construction:'Masonry', Sprinklered:true,  Occupancy:'Retail', NatCatZone:'B', LossRatio:35, BrokerTier:'A', DistanceToCoast:30, YearBuilt:2005},
  {id:'s2',  LOB:'Property', Geography:'UK', TIV:300000000, Construction:'Non-Combustible', Sprinklered:true,  Occupancy:'Data Centre', NatCatZone:'B', LossRatio:20, BrokerTier:'A', DistanceToCoast:50, YearBuilt:2018},
  {id:'s3',  LOB:'Property', Geography:'UK', TIV:140000000, Construction:'Frame', Sprinklered:false, Occupancy:'Construction Site', NatCatZone:'B', LossRatio:45, BrokerTier:'B', DistanceToCoast:10, YearBuilt:2022},
  {id:'s4',  LOB:'Casualty', Geography:'UK', TIV:5000000,   Construction:'N/A',   Sprinklered:false, Occupancy:'Chemical Processing', NatCatZone:'C', LossRatio:65, BrokerTier:'B', DistanceToCoast:100, YearBuilt:1998},
  {id:'s5',  LOB:'Casualty', Geography:'UK', TIV:10000000,  Construction:'N/A',   Sprinklered:false, Occupancy:'Consumer Products', NatCatZone:'B', LossRatio:40, BrokerTier:'A', DistanceToCoast:200, YearBuilt:2012},
  {id:'s6',  LOB:'Marine',   Geography:'UK', TIV:90000000,  Construction:'Offshore', Sprinklered:false, Occupancy:'Offshore Construction', NatCatZone:'A', LossRatio:30, BrokerTier:'A', DistanceToCoast:1.2, YearBuilt:2020},
  {id:'s7',  LOB:'Specialty',Geography:'UK', TIV:20000000,  Construction:'Lab',  Sprinklered:true,  Occupancy:'Medical Device', NatCatZone:'B', LossRatio:85, BrokerTier:'A', DistanceToCoast:60, YearBuilt:2016},
  {id:'s8',  LOB:'Property', Geography:'UK', TIV:240000000, Construction:'Fire Resistive', Sprinklered:true,  Occupancy:'Warehouse', NatCatZone:'B', LossRatio:25, BrokerTier:'A', DistanceToCoast:40, YearBuilt:2014},
  {id:'s9',  LOB:'Property', Geography:'UK', TIV:80000000,  Construction:'Non-Combustible', Sprinklered:true,  Occupancy:'Retail', NatCatZone:'A', LossRatio:28, BrokerTier:'A', DistanceToCoast:25, YearBuilt:2008},
  {id:'s10', LOB:'Specialty',Geography:'UK', TIV:12000000,  Construction:'Lab',  Sprinklered:true,  Occupancy:'Life Science', NatCatZone:'B', LossRatio:50, BrokerTier:'A', DistanceToCoast:80, YearBuilt:2019},
  {id:'s11', LOB:'Property', Geography:'UK', TIV:260000000, Construction:'Masonry', Sprinklered:true, Occupancy:'Industrial', NatCatZone:'C', LossRatio:33, BrokerTier:'A', DistanceToCoast:70, YearBuilt:2002},
  {id:'s12', LOB:'Casualty', Geography:'UK', TIV:3000000,   Construction:'N/A', Sprinklered:false, Occupancy:'Services', NatCatZone:'B', LossRatio:55, BrokerTier:'A', DistanceToCoast:150, YearBuilt:2010}
];

/* --- Rule builder UI --- */
function aDSL(){
  const f=$('#a_field').value, op=$('#a_op').value, v=$('#a_val').value, o=$('#a_outcome').value;
  $('#a_dsl').textContent=`IF ${f} ${op} ${v||'…'} THEN ${o}`;
}
['#a_field','#a_op','#a_val','#a_outcome'].forEach(id=>$(id).addEventListener('input',aDSL));
function clearRuleForm(){ ['a_val','a_rationale'].forEach(id=>$('#'+id).value=''); aDSL(); }
function addRule(){
  const field=$('#a_field').value, op=$('#a_op').value, val=$('#a_val').value.trim(), outcome=$('#a_outcome').value, rationale=$('#a_rationale').value.trim();
  if(!val){ alert('Enter a value'); return; }
  A_RULES.push({field,op,val,outcome,rationale});
  renderARules(); aDSL();
}
function renderARules(){
  const tb=$('#a_rules_tbl tbody');
  tb.innerHTML = A_RULES.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><code>${r.field} ${r.op} ${r.val}</code></td>
      <td><span class="badge">${r.outcome}</span></td>
      <td>${r.rationale||'—'}</td>
      <td><button class="btn2 small" onclick="delARule(${i})">Delete</button></td>
    </tr>`).join('') || `<tr><td colspan="5" class="muted">No rules added.</td></tr>`;
}
function delARule(i){ A_RULES.splice(i,1); renderARules(); }

/* --- Library render --- */
function renderLibrary(){
  const q=($('#lib_q').value||'').toLowerCase();
  const list=LIBRARY.filter(t=>!q || t.name.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q));
  $('#lib_list').innerHTML = list.map(t=>`
    <div class="templateCard" onclick="openTpl('${t.id}','lib')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${t.name}</strong>
        <span class="badge">${t.rules.length} rules</span>
      </div>
      <div class="muted">${t.desc}</div>
      <div class="row"><span class="tag">Library</span></div>
    </div>`).join('');
}

/* --- Save & templates --- */
function referList(){ return ['#a_ref_mn','#a_ref_am','#a_ref_pr','#a_ref_bt'].filter(id=>$(id).checked).map(id=>$(id).nextSibling.textContent.trim()); }
function saveAppetiteTemplate(){
  if(A_RULES.length===0){ alert('Add at least one rule.'); return; }
  const name=$('#a_tpl_name').value.trim()||`Appetite ${Date.now()}`;
  const desc=$('#a_tpl_desc').value.trim();
  const refs=referList(); const note=$('#a_ref_note').value.trim();
  A_TEMPLATES.unshift({id:'at'+Date.now(), name, desc, status:'Draft', refs, note, rules:[...A_RULES]});
  A_RULES=[]; renderARules(); renderAppetiteTemplates(); alert('Template saved.');
}
function referTemplate(){
  const name=$('#a_tpl_name').value.trim()||'(unsaved draft)';
  alert(`Referred “${name}” to: ${referList().join(', ') || '—'}\n\nCommentary:\n${($('#a_ref_note').value||'—')}`);
}
function renderAppetiteTemplates(){
  const q=($('#a_tpl_search').value||'').toLowerCase(); const st=$('#a_tpl_status').value;
  const list=A_TEMPLATES.filter(t=>(!st||t.status===st) && (!q || t.name.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q)));
  $('#a_tpl_list').innerHTML = list.map(t=>`
    <div class="templateCard" onclick="openTpl('${t.id}','user')">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${t.name}</strong> <span class="muted">— ${t.desc||'No description'}</span></div>
        <div class="row">
          <span class="badge">${t.status}</span>
          <button class="btn2 small" onclick="event.stopPropagation(); deleteTemplate('${t.id}')">Delete</button>
        </div>
      </div>
      <div class="muted">Referred: ${t.refs?.join(', ')||'—'}${t.note?` • Note: ${t.note}`:''}</div>
    </div>`).join('') || `<div class="muted">No templates.</div>`;
}
function deleteTemplate(id){ if(!confirm('Delete this template?')) return; A_TEMPLATES = A_TEMPLATES.filter(t=>t.id!==id); renderAppetiteTemplates(); }

/* --- Template detail modal + impact preview --- */
let TPL_CTX=null; // {source:'lib'|'user', tpl:obj}
function toggleTpl(open){ $('#tplModal').style.display=open?'flex':'none'; }
function openTpl(id, source){
  const tpl = (source==='lib'? LIBRARY.find(x=>x.id===id) : A_TEMPLATES.find(x=>x.id===id));
  if(!tpl) return;
  TPL_CTX={source, tpl};
  $('#tplTitle').textContent=tpl.name;
  $('#tplDesc').textContent=tpl.desc || '—';
  // Rules + human explanations
  const rulesHTML = tpl.rules.map(r=>{
    const human = humanExplain(r);
    return `<div class="card" style="border:1px solid var(--border);border-radius:10px;padding:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <code>${r.field} ${r.op} ${r.val}</code>
        <span class="badge">${r.outcome}</span>
      </div>
      <div class="muted" style="margin-top:4px">${human}${r.rationale?` • Rationale: ${r.rationale}`:''}</div>
    </div>`;
  }).join('');
  $('#tplRules').innerHTML=rulesHTML || '<div class="muted">No rules.</div>';

  // Impact preview
  const impact = evaluateTemplate(tpl.rules, LAST_YEAR);
  renderImpact(impact);

  toggleTpl(true);
}
function tplLoadToBuilder(){ if(!TPL_CTX) return; A_RULES=[...TPL_CTX.tpl.rules.map(r=>({...r}))]; renderARules(); toggleTpl(false); }
function humanExplain(r){
  const f=r.field, op=r.op, v=r.val, out=r.outcome;
  const prettify=(x)=>x.replace(/_/g,' ').replace(/\b([a-z])/g,(m,p)=>p.toUpperCase());
  if(op==='is') return `${f} is “${v}” → ${out}`;
  if(op==='in')  return `${f} in [${v.split(',').map(s=>s.trim()).join(', ')}] → ${out}`;
  if(op==='contains') return `${f} contains “${v}” → ${out}`;
  if(op==='!=') return `${f} is not “${v}” → ${out}`;
  if(op==='>=') return `${f} ≥ ${v} → ${out}`;
  if(op==='<=') return `${f} ≤ ${v} → ${out}`;
  if(op==='<')  return `${f} &lt; ${v} → ${out}`;
  if(op==='>')  return `${f} &gt; ${v} → ${out}`;
  if(op==='between'){ const [a,b]=v.split('..'); return `${f} between ${a} and ${b} → ${out}`; }
  return `${prettify(f)} ${op} ${v} → ${out}`;
}

/* Evaluate rules on a dataset (first-match wins; default Refer) */
function evaluateTemplate(rules, dataset){
  const results = dataset.map(item=>{
    for(const r of rules){
      if(matchRule(r,item)) return {id:item.id, out:r.outcome, rule:r};
    }
    return {id:item.id, out:'Refer', rule:null};
  });
  const acc=results.filter(x=>x.out==='Accept').length;
  const ref=results.filter(x=>x.out==='Refer').length;
  const dec=results.filter(x=>x.out==='Decline').length;
  // count rule triggers
  const byRule={};
  results.forEach(x=>{ if(x.rule){ const key=`${x.rule.field} ${x.rule.op} ${x.rule.val} → ${x.rule.outcome}`; byRule[key]=(byRule[key]||0)+1; }});
  const triggers=Object.entries(byRule).sort((a,b)=>b[1]-a[1]).slice(0,5);
  return {acc,ref,dec,total:dataset.length,triggers};
}
function matchRule(r, item){
  const f=r.field; const op=r.op; const v=r.val;
  const val = item[f];
  if(val===undefined) return false;
  if(op==='is') return String(val).toLowerCase()===String(v).toLowerCase();
  if(op==='!=') return String(val).toLowerCase()!==String(v).toLowerCase();
  if(op==='in'){ const set=v.split(',').map(s=>s.trim().toLowerCase()); return set.includes(String(val).toLowerCase()); }
  if(op==='contains') return String(val).toLowerCase().includes(String(v).toLowerCase());
  if(op==='>=') return (+val)>= (+v);
  if(op==='<=') return (+val)<= (+v);
  if(op==='>')  return (+val) > (+v);
  if(op==='<')  return (+val) < (+v);
  if(op==='between'){ const [a,b]=v.split('..').map(Number); const num=+val; return num>=a && num<=b; }
  return false;
}
function renderImpact(imp){
  const pct = imp.total? Math.round((imp.acc/imp.total)*100) : 0;
  $('#barAcc').style.width = pct+'%';
  $('#accCount').textContent = `Accept: ${imp.acc}`;
  $('#refCount').textContent = `Refer: ${imp.ref}`;
  $('#decCount').textContent = `Decline: ${imp.dec}`;
  $('#tplTriggers').innerHTML = imp.triggers.map(([k,c])=>`<div class="badge">${k} • ${c}</div>`).join('') || '<div class="muted">No dominant triggers.</div>';
}

/* Preview current working rules quickly */
function previewImpact(rules){
  if(!rules || !rules.length){ alert('Add rules first.'); return; }
  const imp=evaluateTemplate(rules, LAST_YEAR);
  alert(`Impact on last year (${imp.total} subs):\nAccept ${imp.acc} • Refer ${imp.ref} • Decline ${imp.dec}`);
}

/* ===== Wordings (unchanged) ===== */
let W_LIST=[
  {id:'w1', code:'LMA3100', title:'General Conditions', lob:'Property', category:'Condition', status:'Approved', text:'All risks of direct physical loss...', tags:['core','base'], submittedBy:'Legal Bot', submittedAt: Date.now()-45*86400000},
  {id:'w2', code:'LMA5522', title:'Cyber Exclusion', lob:'Property', category:'Exclusion', status:'Approved', text:'This policy excludes cyber loss...', tags:['exclusion','cyber'], submittedBy:'Legal Bot', submittedAt: Date.now()-30*86400000},
  {id:'w3', code:'LMA9001', title:'Flood Endorsement', lob:'Property', category:'Endorsement', status:'Pending', text:'Flood coverage applies subject to...', tags:['flood','endorsement'], submittedBy:'Marin Nikolla', submittedAt: Date.now()-5*86400000},
  {id:'w4', code:'LMA2101', title:'Definition: Occurrence', lob:'Casualty', category:'Definition', status:'Draft', text:'Occurrence means an accident...', tags:['definition'], submittedBy:'Alex Morgan', submittedAt: Date.now()-1*86400000},
];
let W_TEMPLATES=[
  {id:'wt1', name:'PAR Base v1', status:'Approved', clauses:['w1','w2'], submittedBy:'Marin Nikolla', submittedAt:Date.now()-20*86400000},
  {id:'wt2', name:'Property Flood v1', status:'Pending', clauses:['w1','w3'], submittedBy:'Priya Rao', submittedAt:Date.now()-3*86400000},
];
let W_COMPOSE=[];

function daysSince(ts){ return Math.max(0, Math.floor((Date.now()-ts)/86400000)); }
function clearWFilters(){ ['w_q','w_lob','w_cat','w_status'].forEach(id=>$('#'+id).value=''); renderWordings(); }
function renderWordings(){
  const q=($('#w_q').value||'').toLowerCase(), lob=$('#w_lob').value, cat=$('#w_cat').value, st=$('#w_status').value;
  const rows=W_LIST.filter(w=>{
    const okQ=!q||[w.code,w.title,w.text, ...(w.tags||[])].join(' ').toLowerCase().includes(q);
    return okQ && (!lob||w.lob===lob) && (!cat||w.category===cat) && (!st||w.status===st);
  });
  const tb=$('#w_tbl tbody');
  tb.innerHTML = rows.map(w=>`
    <tr>
      <td>${w.code}</td>
      <td>${w.title}</td>
      <td>${w.lob}</td>
      <td>${w.category}</td>
      <td><span class="badge">${w.status}</span></td>
      <td>${(w.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ')}</td>
      <td>${w.status==='Pending'?`${daysSince(w.submittedAt)}d • ${w.submittedBy}`:'—'}</td>
      <td>
        <div class="row">
          <button class="btn2 small" onclick="wEdit('${w.id}')">Edit</button>
          <button class="btn2 small" onclick="wAddToComposer('${w.id}')">Add</button>
          <button class="btn2 small" onclick="wSendClause('${w.id}')">Send to Legal</button>
        </div>
      </td>
    </tr>`).join('') || `<tr><td colspan="8" class="muted">No wordings found.</td></tr>`;
}
function wEdit(id){
  const w=W_LIST.find(x=>x.id===id); if(!w) return;
  $('#w_edit_code').value=w.code; $('#w_edit_title').value=w.title; $('#w_edit_lob').value=w.lob; $('#w_edit_cat').value=w.category;
  $('#w_edit_text').value=w.text; $('#w_edit_tags').value=(w.tags||[]).join(', ');
  $('#page-wordings').scrollIntoView({behavior:'smooth'});
}
function wResetEditor(){ ['w_edit_code','w_edit_title','w_edit_text','w_edit_tags'].forEach(id=>$('#'+id).value=''); $('#w_edit_lob').value='Property'; $('#w_edit_cat').value='Condition'; }
function wSaveEdit(){
  const code=$('#w_edit_code').value.trim(); if(!code){ alert('Code required'); return; }
  const existing=W_LIST.find(x=>x.code===code);
  const obj={id: existing?.id || ('w'+Date.now()), code, title:$('#w_edit_title').value.trim(), lob:$('#w_edit_lob').value, category:$('#w_edit_cat').value,
            text:$('#w_edit_text').value, tags:$('#w_edit_tags').value.split(',').map(s=>s.trim()).filter(Boolean), status:'Draft', submittedBy:'Marin Nikolla', submittedAt:Date.now()};
  if(existing){ Object.assign(existing,obj); } else { W_LIST.unshift(obj); }
  renderWordings(); alert('Saved as Draft.');
}
function wSendForApproval(){
  const code=$('#w_edit_code').value.trim(); if(!code){ alert('Load or create a clause first.'); return; }
  const w=W_LIST.find(x=>x.code===code); if(!w){ alert('Clause not found.'); return; }
  w.status='Pending'; w.submittedBy='Marin Nikolla'; w.submittedAt=Date.now();
  renderWordings(); alert('Sent to Legal and Team Lead.');
}
function wSendClause(id){ const w=W_LIST.find(x=>x.id===id); if(!w) return; w.status='Pending'; w.submittedBy='Marin Nikolla'; w.submittedAt=Date.now(); renderWordings(); alert(`Clause ${w.code} sent to Legal.`); }
function wAddToComposer(id){ if(!W_COMPOSE.includes(id)) W_COMPOSE.push(id); renderComposer(); }
function renderComposer(){
  const box=$('#w_compose');
  if(!W_COMPOSE.length){ box.innerHTML='No clauses added yet.'; return; }
  box.innerHTML=W_COMPOSE.map(cid=>{
    const w=W_LIST.find(x=>x.id===cid); if(!w) return '';
    return `<div class="templateCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>${w.code} — ${w.title}</strong>
        <button class="btn2 small" onclick="wRemoveFromComposer('${cid}')">Remove</button>
      </div>
      <div class="muted">${w.lob} • ${w.category} • ${w.status} ${w.status==='Pending'?`• ${daysSince(w.submittedAt)}d`:''}</div>
      <div style="white-space:pre-wrap">${w.text.slice(0,180)}${w.text.length>180?'…':''}</div>
    </div>`;
  }).join('');
}
function wRemoveFromComposer(id){ W_COMPOSE=W_COMPOSE.filter(x=>x!==id); renderComposer(); }
function wClearComposer(){ W_COMPOSE=[]; renderComposer(); }
function wSaveTemplate(){
  if(!W_COMPOSE.length){ alert('Add clauses first.'); return; }
  const name=$('#w_tpl_name').value.trim()||('Wording '+Date.now());
  W_TEMPLATES.unshift({id:'wt'+Date.now(),name, status:'Draft', clauses:[...W_COMPOSE], submittedBy:'Marin Nikolla', submittedAt:Date.now()});
  wClearComposer(); $('#w_tpl_name').value=''; renderWTemplates(); alert('Wording template saved.');
}
function renderWTemplates(){
  const q=($('#w_tpl_q').value||'').toLowerCase(); const st=$('#w_tpl_status').value; const box=$('#w_tpl_list');
  const list=W_TEMPLATES.filter(t=>(!st||t.status===st) && (!q|| t.name.toLowerCase().includes(q)));
  box.innerHTML=list.map(t=>{
    const clauses = t.clauses.map(id=>W_LIST.find(x=>x.id===id)).filter(Boolean);
    return `<div class="templateCard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>${t.name}</strong> ${t.status==='Pending'?`<span class="badge">${daysSince(t.submittedAt)}d pending</span>`:''}</div>
        <div class="row">
          <span class="badge">${t.status}</span>
          <button class="btn2 small" onclick="event.stopPropagation(); wSendTpl('${t.id}')">Send to Legal</button>
          <button class="btn2 small" onclick="event.stopPropagation(); wDeleteTpl('${t.id}')">Delete</button>
        </div>
      </div>
      <div class="muted">Submitted by ${t.submittedBy}</div>
      <div class="list" style="margin-top:6px">
        ${clauses.map(c=>`<div class="badge">${c.code} • ${c.title} <span class="muted">(${c.status})</span></div>`).join(' ')}
      </div>
    </div>`;
  }).join('') || `<div class="muted">No templates.</div>`;
}
function wSendTpl(id){ const t=W_TEMPLATES.find(x=>x.id===id); if(t){ t.status='Pending'; t.submittedAt=Date.now(); t.submittedBy='Marin Nikolla'; renderWTemplates(); alert('Template sent to Legal & Team Lead.'); } }
function wDeleteTpl(id){ if(!confirm('Delete this wording template?')) return; W_TEMPLATES=W_TEMPLATES.filter(x=>x.id!==id); renderWTemplates(); }

/* Init */
setTab('appetite');
aDSL(); renderARules(); renderLibrary(); renderAppetiteTemplates();
renderWordings(); renderWTemplates(); renderComposer();
</script>
</body>
</html>
