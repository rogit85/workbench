<!DOCTYPE html>
<html lang="en">
<head>
  <title>Underwriting Workbench — Risk</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@0.456.0/dist/umd/lucide.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --brand:#6F1111; --brand-2:#7A1414;
      --ink:#0F1216; --text:#2A2F33; --muted:#6B757E;
      --bg:#F6F7F9; --surface:#fff; --border:#E6E9EE;
      --shadow:0 10px 30px rgba(17,20,24,.06),0 2px 8px rgba(17,20,24,.04);
      --green:#2E7D32; --amber:#FB8C00; --blue:#1976D2; --purple:#7C3AED; --grey:#667085; --danger:#B51212;
      --gap:16px;
      --event-red:#B51212; --event-amber:#C77800; --event-purple:#6D28D9; --event-blue:#1D4ED8; --event-green:#2E7D32; --event-grey:#6B7280;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
    a{color:inherit;text-decoration:none}

    /* App bar */
    .appbar{position:sticky;top:0;z-index:1000;display:grid;grid-template-columns:280px 1fr auto;gap:16px;align-items:center;padding:14px 20px;background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#fff,rgba(255,255,255,.9));display:grid;place-items:center}
    .logo svg{width:22px;height:22px;fill:var(--brand)}
    .title{font-weight:800}
    .appnav{display:flex;gap:8px}
    .navbtn{border:none;background:rgba(255,255,255,.14);color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .navbtn.primary{background:#fff;color:var(--brand)}
    .profile{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.24);border-radius:999px;padding:6px 10px 6px 6px}
    .avatar{width:34px;height:34px;border-radius:999px;background:#fff;display:grid;place-items:center;color:var(--brand);font-weight:900}

    /* Page grid: left timeline, center main, right rail */
    .wrap{max-width:1800px;margin:0 auto;padding:32px;display:grid;gap:24px}
    .grid3{display:grid;grid-template-columns:380px minmax(0,1fr) 450px;gap:24px}
    .col{display:grid;gap:24px}
    .sticky{position:sticky;top:120px;display:grid;gap:24px;max-height:calc(100vh - 140px);overflow:visible}

    .btn2{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
    .btn2.primary{background:linear-gradient(180deg,var(--brand-2),var(--brand));border-color:transparent;color:#fff}
    .btn2.danger{background:linear-gradient(180deg,#b91c1c,#7f1d1d);color:#fff;border-color:transparent}
    .btn2.small{padding:6px 10px}
    .btnIcon{width:18px;height:18px;stroke:#667085}

    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);transition:box-shadow 0.2s ease}
    .card:hover{box-shadow:0 15px 40px rgba(17,20,24,.08),0 3px 12px rgba(17,20,24,.06)}
    .hd{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#fafbfc,#f8f9fa)}
    .bd{padding:20px}
    .muted{color:var(--muted);font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;border:1px solid var(--border);font-size:12px;font-weight:600;background:#fff;transition:all 0.2s ease}
    .badge:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:6px 12px;border:1px solid var(--border);border-radius:20px;font-size:12px;font-weight:500;background:#fff;transition:all 0.2s ease}
    .tag:hover{background:#f8f9fa;transform:translateY(-1px)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

    /* Overview expand */
    .moreDetails{display:none;border-top:1px dashed var(--border);margin-top:16px;padding-top:16px;background:#f8f9fa;border-radius:8px;padding:16px}
    .moreDetails.show{display:block}
    
    /* Detailed Data View */
    .detailed-data-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-top:12px}
    .data-section{background:#fff;border-radius:8px;padding:16px;border:1px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .data-section h4{color:var(--brand);font-size:14px;font-weight:700;margin:0 0 12px 0;padding-bottom:8px;border-bottom:1px solid var(--border)}
    .data-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #e9ecef}
    .data-row:last-child{border-bottom:none}
    .data-label{font-weight:600;color:#495057;font-size:12px;min-width:120px}
    .data-value{color:#212529;font-size:12px;text-align:right;font-weight:500}
    
    /* Timeline Categories */
    .timeline.standard-view .evt{display:none}
    .timeline.standard-view .evt.stage-event{display:block}
    .evt.admin{border-left-color:#6c757d}
    .evt.decision{border-left-color:#007bff}
    .evt.adjustment{border-left-color:#ffc107}
    .evt.stage-event{border-left-color:#28a745}
    
    /* Enhanced overview section */
    .overview-section{background:linear-gradient(135deg,#fff,#f8f9fa);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .overview-header{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;padding:20px;display:flex;justify-content:space-between;align-items:center}
    .overview-content{padding:24px;display:grid;grid-template-columns:1.3fr 0.7fr;gap:24px}
    .risk-info{display:grid;gap:16px}
    .risk-meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .meta-item{display:flex;flex-direction:column;gap:4px}
    .meta-label{font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);font-weight:700}
    .meta-value{font-size:14px;font-weight:600;color:var(--text)}
    .status-badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .priority-badge{background:linear-gradient(135deg,#fef3c7,#fde68a);color:#92400e;border-color:#f59e0b}
    .stage-badge{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#1e40af;border-color:#3b82f6}

    /* Map */
    #map{height:400px;border:1px solid var(--border);border-radius:12px}
    .legend{display:flex;gap:12px;align-items:center}
    .legend .sw{width:14px;height:14px;border-radius:3px;border:1px solid var(--border)}
    .sw-flood{background:rgba(111,17,17,.18);border-color:rgba(111,17,17,.4)}
    .sw-site{background:#7A1414}

    /* Tables */
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.1)} 
    th,td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    th{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:#6B757E;background:#f8f9fa;font-weight:700}
    tr.sel{background:#FFF3F3}
    tr:hover{background:#f8f9fa}
    tbody tr:last-child td{border-bottom:none}

    /* Documents */
    .list{display:grid;gap:12px}
    .docRow{display:flex;gap:12px;align-items:center;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;transition:all 0.2s ease}
    .docRow:hover{background:#f8f9fa;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .docRow .grow{flex:1}
    .input{padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:14px;transition:border-color 0.2s ease}
    .input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(111,17,17,.1)}

    /* Modals & Drawer */
    .modal{position:fixed;inset:0;background:rgba(16,18,24,.45);display:none;align-items:center;justify-content:center;z-index:1201}
    .panel{width:min(1000px,96vw);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .panel-lg{width:min(1200px,96vw)}
    .actionsBar{display:flex;gap:8px;flex-wrap:wrap}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);display:none;z-index:1500}

    .drawer{position:fixed;top:0;right:-720px;width:min(700px,96vw);height:100vh;background:#fff;border-left:1px solid var(--border);box-shadow:var(--shadow);transition:right .28s ease;z-index:1300;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer .dhd{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .drawer .dbd{padding:14px 16px;overflow:auto;display:grid;gap:12px}
    .section{border:1px solid var(--border);border-radius:12px;padding:12px}

    /* Underwriter Notes (revamped) */
    .notesHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .noteGrid{display:grid;grid-template-columns:1fr;gap:10px;max-height:460px;overflow:auto;padding-right:4px}
    .noteCard{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;display:grid;gap:6px}
    .noteMeta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .tagChip{display:inline-flex;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;margin-right:6px}

    /* Workflow modal */
    .wf-timeline{position:relative;margin:4px 0 14px 0;padding:18px 8px}
    .wf-line{height:4px;background:#E6E9EE;border-radius:999px;position:relative}
    .wf-stages{display:flex;justify-content:space-between;align-items:center;margin-top:-10px}
    .wf-node{position:relative;text-align:center;flex:1}
    .wf-dot{width:16px;height:16px;border-radius:999px;background:#D1D5DB;border:2px solid #fff;box-shadow:0 0 0 2px #E6E9EE;margin:0 auto;cursor:pointer}
    .wf-node.completed .wf-dot{background:#2E7D32;box-shadow:0 0 0 2px rgba(46,125,50,.25)}
    .wf-node.active .wf-dot{background:#7C3AED;box-shadow:0 0 0 2px rgba(124,58,237,.25)}
    .wf-label{margin-top:6px;font-size:12px;color:#667085;font-weight:600}
    .wf-date{font-size:11px;color:#98A2B3}
    .wf-line-fill{position:absolute;top:0;left:0;height:4px;background:linear-gradient(90deg,#2E7D32,#7C3AED);border-radius:999px;transition:width .2s}
    .wf-col2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .wf-section{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
    .wf-row{display:flex;align-items:center;gap:10px;padding:8px 6px;border-radius:10px}
    .wf-row:hover{background:#F9FAFB}
    .wf-confirm{position:sticky;bottom:0;background:#fff;border-top:1px solid var(--border);display:none;gap:8px;align-items:center;padding:10px;border-radius:0 0 16px 16px}
    .wf-confirm textarea{flex:1;min-height:44px}
    .wf-stages .wf-node { min-width: 0; }
    .wf-dot { display: inline-block; }

    /* Attestations scroll box */
    .attScroll{max-height:320px;overflow:auto;padding-right:6px}

    /* Map container */
    #map{height:400px;width:100%;border-radius:8px;border:1px solid var(--border)}
    
    /* Left vertical timeline card */
    .timeline{position:relative;padding-left:20px;max-height:calc(100vh - 200px);overflow:visible;padding-right:8px}
    .timeline::before{content:"";position:absolute;left:10px;top:12px;bottom:12px;width:3px;background:linear-gradient(180deg,var(--brand),var(--brand-2));border-radius:2px}
    .titem{position:relative;margin:0 0 16px 0;padding-left:12px}
    .titem .dot{position:absolute;left:-4px;top:6px;width:12px;height:12px;border-radius:999px;border:3px solid #fff;box-shadow:0 0 0 2px var(--border);transition:all 0.2s ease}
    .evt{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;transition:all 0.2s ease;cursor:pointer}
    
    /* Timeline navigation */
    .timeline-nav{display:flex;justify-content:center;margin-top:16px;gap:4px}
    .timeline-nav-chevron{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid var(--border);border-radius:50%;background:#fff;cursor:pointer;transition:all 0.2s ease;color:var(--brand)}
    .timeline-nav-chevron:hover{background:var(--brand);color:#fff;transform:scale(1.1)}
    .timeline-nav-chevron:disabled{opacity:0.3;cursor:not-allowed;transform:none;background:#f8f9fa;color:#6b7280}
    .timeline-nav-chevron:disabled:hover{background:#f8f9fa;color:#6b7280;transform:none}
    
    /* Pending referrals list */
    .pending-referrals{background:#fff3cd;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:16px}
    .pending-referrals h4{color:#92400e;margin:0 0 8px 0;font-size:14px;font-weight:600}
    .referral-item{background:#fff;border:1px solid #f59e0b;border-radius:6px;padding:8px;margin-bottom:6px;font-size:12px}
    .referral-item:last-child{margin-bottom:0}
    .referral-status{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-right:6px}
    .referral-status.pending{background:#fef3c7;color:#92400e}
    .referral-status.peer-review{background:#dbeafe;color:#1e40af}
    
    /* Document preview and tags */
    .docRow{display:flex;gap:12px;align-items:center;border:1px solid var(--border);border-radius:8px;padding:10px;background:#fff;transition:all 0.2s ease;cursor:pointer}
    .docRow:hover{background:#f8f9fa;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .docPreview{width:40px;height:40px;border-radius:6px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
    .docInfo{flex:1;min-width:0}
    .docName{font-weight:600;font-size:13px;color:#111827;margin-bottom:2px}
    .docMeta{font-size:11px;color:#6b7280;margin-bottom:4px}
    .docTags{display:flex;gap:4px;flex-wrap:wrap}
    .docTag{display:inline-block;padding:2px 6px;background:#e5e7eb;color:#374151;border-radius:4px;font-size:10px;font-weight:500}
    .docActions{display:flex;gap:4px;position:relative;z-index:1}
    .docBtn{display:flex;align-items:center;gap:2px;padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;font-size:10px;cursor:pointer;transition:all 0.2s ease;position:relative;z-index:2}
    .docBtn:hover{background:#f3f4f6}
    
    /* Document preview modal */
    .docModal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:2000}
    .docModal.show{display:flex}
    .docModalContent{background:#fff;border-radius:12px;max-width:90vw;max-height:90vh;overflow:auto;position:relative}
    .docModalHeader{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--border)}
    .docModalBody{padding:16px}
    .docModalClose{background:none;border:none;font-size:24px;cursor:pointer;color:#6b7280}
    
    .evt:hover{background:#f8f9fa;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .evtHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .evtHead strong{font-size:13px;font-weight:700;color:var(--text)}
    .evtTime{font-size:11px;color:var(--muted);font-weight:500}
    .evtBody{display:none;margin-top:8px;color:#111827;font-size:12px;line-height:1.4;padding:8px;background:#f8f9fa;border-radius:6px;border-left:3px solid var(--brand)}
    .evt.show .evtBody{display:block}
    
    /* Collapsible sections */
    .collapsible .hd{cursor:pointer;transition:all 0.2s ease}
    .collapsible .hd:hover{background:linear-gradient(135deg,var(--brand-2),var(--brand))}
    .collapsible .hd:hover *{color:#fff !important}
    .collapsible .hd:hover .btn2{color:#111827 !important;background:#fff !important;border-color:#fff !important}
    .collapsible .hd:hover .btn2:hover{background:#f8f9fa !important;color:#111827 !important}
    .collapsible .hd.collapsed .hd-icon{transform:rotate(180deg)}
    .hd-icon{transition:transform 0.2s ease;margin-left:8px}
    .collapsible .bd{transition:all 0.3s ease}
    .collapsible .bd.collapsed{display:none}
    
    /* Section summary */
    .section-summary{display:block;font-size:11px;font-weight:400;color:#6b7280;margin-top:2px;opacity:0;transition:opacity 0.2s ease}
    .collapsible .hd.collapsed .section-summary{opacity:1;color:#6b7280}
    .collapsible .hd:hover .section-summary{color:rgba(255,255,255,0.9)}
    
    /* Document classification dropdown */
    .doc-class-dropdown{position:relative;display:inline-block;z-index:9998}
    .doc-class-btn{display:flex;align-items:center;gap:4px;padding:4px 8px;border:1px solid var(--border);border-radius:4px;background:#fff;cursor:pointer;font-size:10px;transition:all 0.2s ease;position:relative;z-index:9999}
    .doc-class-btn:hover{background:#f8f9fa}
    .doc-class-menu{position:fixed;background:#fff;border:1px solid var(--border);border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:99999;min-width:120px;display:none}
    .doc-class-menu.show{display:block}
    .doc-class-item{padding:8px 12px;cursor:pointer;font-size:11px;transition:background 0.2s ease}
    .doc-class-item:hover{background:#f8f9fa}
    .doc-class-item.selected{background:var(--brand);color:#fff}

    .dot-red{background:var(--event-red)} .dot-amber{background:var(--event-amber)}
    .dot-purple{background:var(--event-purple)} .dot-blue{background:var(--event-blue)}
    .dot-green{background:var(--event-green)} .dot-grey{background:var(--event-grey)}

    /* Responsive design */
    @media(max-width:1280px){ 
      .grid3{grid-template-columns:1fr} 
      .sticky{position:relative;top:auto;max-height:none}
      .overview-content{grid-template-columns:1fr}
      .risk-meta{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    }
    
    @media(max-width:768px){
      .wrap{padding:16px}
      .grid3{gap:16px}
      .overview-header{flex-direction:column;align-items:flex-start;gap:12px}
      .status-badges{width:100%;justify-content:flex-start}
      .row{flex-direction:column;align-items:stretch}
      .btn2{justify-content:center}
    }
  </style>
</head>
<body>
<header class="appbar">
  <div class="brand">
    <div class="logo" aria-label="Workbench">
      <svg viewBox="0 0 24 24"><path d="M12 2l7 3v6c0 5-3.5 8.4-7 9.9C8.5 19.4 5 16 5 11V5l7-3zM12 7a2.75 2.75 0 110 5.5A2.75 2.75 0 0112 7zm0 6.5c-2.8 0-5 1.6-5 3.5v1.2c1.7 1.1 3.5 2 5 2.6 1.5-.6 3.3-1.5 5-2.6V17c0-1.9-2.2-3.5-5-3.5z"/></svg>
    </div>
    <div><div style="font-size:12px;opacity:.9;letter-spacing:.18em;text-transform:uppercase">Underwriting Workbench</div><div class="title">Risk</div></div>
  </div>
  <div class="appnav">
    <button class="navbtn" onclick="location.href='index.html'">Home</button>
    <button class="navbtn" onclick="location.href='workqueue.html'">Work Queue</button>
    <button class="navbtn" onclick="location.href='dashboard.html'">Dashboard</button>
    <button class="navbtn" onclick="location.href='toolkit.html'">Toolkit</button>
  </div>
  <div class="profile"><div class="avatar">MN</div><div><div style="font-weight:700">Marin Nikolla</div><div style="font-size:12px;opacity:.85">Lead Underwriter</div></div></div>
</header>

<main class="wrap">
  <!-- Top actions -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div class="row">
      <button class="btn2 primary" onclick="openActions()">
        <i data-lucide="zap" class="btnIcon"></i> Risk Actions
      </button>
      <button class="btn2" onclick="handleWorkflowClick()">
        <i data-lucide="git-branch" class="btnIcon"></i> Workflow
      </button>
      <button class="btn2" onclick="openNotes()">
        <i data-lucide="notebook-text" class="btnIcon"></i> Notes
      </button>
    </div>
    <div class="row">
      <button class="btn2 small" onclick="window.print()">
        <i data-lucide="printer" class="btnIcon"></i> Print
      </button>
      <button class="btn2 small" onclick="location.href='workqueue.html'">
        <i data-lucide="arrow-left" class="btnIcon"></i> Back to Queue
      </button>
    </div>
  </div>

  <div class="grid3">
    <!-- LEFT TIMELINE -->
    <aside class="sticky">
      <section class="card">
        <div class="hd">
          <strong>Activity Timeline</strong>
          <div class="row">
            <button class="btn2 small" onclick="toggleTimelineView()" id="timelineToggle">
              <i data-lucide="activity" class="btnIcon"></i> Detailed
            </button>
            <button class="btn2 small" onclick="loadMoreAudit()">
              <i data-lucide="clock" class="btnIcon"></i> More
            </button>
          </div>
        </div>
        <div class="bd timeline" id="timelineBox">
          <!-- events injected -->
        </div>
        <div class="timeline-nav" id="timelineNav" style="display:none">
          <div class="timeline-nav-chevron" id="prevTimeline" onclick="navigateTimeline(-1)">
            <i data-lucide="chevron-up" class="btnIcon"></i>
          </div>
          <div class="timeline-nav-chevron" id="nextTimeline" onclick="navigateTimeline(1)">
            <i data-lucide="chevron-down" class="btnIcon"></i>
          </div>
        </div>
      </section>
    </aside>

    <!-- CENTER MAIN -->
    <div class="col">
      <!-- Overview -->
      <section class="overview-section">
        <div class="overview-header">
          <div>
            <h1 id="r_name" style="margin:0;font-size:24px;font-weight:800">Risk</h1>
            <div style="font-size:14px;opacity:0.9;margin-top:4px" id="r_insured">—</div>
          </div>
          <div class="status-badges">
            <span id="r_stage" class="badge stage-badge">Stage</span>
            <span id="r_priority" class="badge priority-badge">Priority</span>
            <button class="btn2 small" onclick="toggleDetails()" style="background:#fff;color:var(--brand);border-color:#fff">
              <i data-lucide="info" class="btnIcon"></i> More Details
            </button>
          </div>
        </div>
        <div class="overview-content">
          <div class="risk-info">
            <div>
              <div class="meta-label">Broker Information</div>
              <div class="meta-value" id="r_broker">—</div>
            </div>
            <div class="risk-meta">
              <div class="meta-item">
                <div class="meta-label">Line of Business</div>
                <div class="meta-value" id="r_lob">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Product</div>
                <div class="meta-value" id="r_product">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Inception Date</div>
                <div class="meta-value" id="r_eff">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Expiry Date</div>
                <div class="meta-value" id="r_exp">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Estimated Premium</div>
                <div class="meta-value" id="r_premium">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Policy Limits</div>
                <div class="meta-value" id="r_limits">—</div>
              </div>
            </div>
            <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
              <span class="tag" id="r_ded">Deductible</span>
            </div>
          </div>
          <div>
            <div class="meta-label" style="margin-bottom:12px">Key Risk Information</div>
            <div style="display:grid;gap:8px;font-size:13px">
              <div class="meta-item">
                <div class="meta-label">Channel</div>
                <div class="meta-value" id="r_channel">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Business Type</div>
                <div class="meta-value" id="r_biz">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Occupancy</div>
                <div class="meta-value" id="r_occ">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Construction</div>
                <div class="meta-value" id="r_constr">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Sprinklered</div>
                <div class="meta-value" id="r_spk">—</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Loss Ratio (5y)</div>
                <div class="meta-value" id="r_lr">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- expand panel -->
        <div id="moreDetails" class="moreDetails">
          <div class="detailed-data-grid">
            <div class="data-section">
              <h4>Policy Details</h4>
              <div class="data-row">
                <span class="data-label">Placement:</span>
                <span class="data-value" id="d_place">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Domicile:</span>
                <span class="data-value" id="d_dom">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Currency:</span>
                <span class="data-value" id="d_cur">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Exposure Limit:</span>
                <span class="data-value" id="d_exp">—</span>
              </div>
            </div>
            <div class="data-section">
              <h4>Line Participation</h4>
              <div class="data-row">
                <span class="data-label">Written Line:</span>
                <span class="data-value" id="d_wri">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Signed Line:</span>
                <span class="data-value" id="d_sig">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Commission:</span>
                <span class="data-value" id="d_com">—</span>
              </div>
            </div>
            <div class="data-section">
              <h4>Broker Information</h4>
              <div class="data-row">
                <span class="data-label">Organization:</span>
                <span class="data-value" id="d_bro">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Contact:</span>
                <span class="data-value" id="d_bro_contact">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Email:</span>
                <span class="data-value" id="d_bro_email">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Phone:</span>
                <span class="data-value" id="d_bro_phone">—</span>
              </div>
            </div>
            <div class="data-section">
              <h4>Risk Characteristics</h4>
              <div class="data-row">
                <span class="data-label">Construction:</span>
                <span class="data-value" id="d_construction">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Occupancy:</span>
                <span class="data-value" id="d_occupancy">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Sprinklered:</span>
                <span class="data-value" id="d_sprinklered">—</span>
              </div>
              <div class="data-row">
                <span class="data-label">Loss Ratio (5y):</span>
                <span class="data-value" id="d_loss_ratio">—</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Map + SOV -->
      <section class="card collapsible" id="sovCard">
        <div class="hd" onclick="toggleSection(this)">
          <div>
            <strong>Locations, SOV & Flood</strong>
            <span class="section-summary" id="sov-summary"></span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="legend">
              <span class="sw sw-flood"></span><span class="muted">Flood</span>
              <span class="sw sw-site"></span><span class="muted">Site</span>
            </div>
            <i data-lucide="chevron-down" class="hd-icon"></i>
          </div>
        </div>
        <div class="bd">
          <div id="map"></div>
          <div class="row" style="margin-top:8px">
            <label class="badge"><input type="checkbox" id="ukFloodToggle"> UK Flood</label>
            <label class="badge"><input type="checkbox" id="usFloodToggle"> US FEMA Flood</label>
          </div>
          <div style="margin-top:12px;overflow:auto">
            <table id="sovTbl"><thead><tr><th>#</th><th>Address</th><th>Lat</th><th>Lon</th><th>TIV</th><th>Flood Zone</th><th></th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </section>

      <!-- Loss history -->
      <section class="card collapsible">
        <div class="hd" onclick="toggleSection(this)">
          <div>
            <strong>Loss History (5y)</strong>
            <span class="section-summary" id="loss-summary"></span>
          </div>
          <i data-lucide="chevron-down" class="hd-icon"></i>
        </div>
        <div class="bd">
          <table><thead><tr><th>Year</th><th>Claims</th><th>Paid</th><th>Outstanding</th><th>Large Loss Notes</th></tr></thead>
            <tbody id="lossTbody"></tbody></table>
        </div>
      </section>

      <!-- Attestation log -->
      <section class="card collapsible">
        <div class="hd" onclick="toggleSection(this)">
          <div>
            <strong>Compliance & Attestations</strong>
            <span class="section-summary" id="attest-summary"></span>
          </div>
          <i data-lucide="chevron-down" class="hd-icon"></i>
        </div>
        <div class="bd">
          <div id="attLog" class="list muted">No attestations recorded.</div>
        </div>
      </section>
    </div>

    <!-- RIGHT RAIL -->
    <aside class="sticky">
      <!-- Pending Referrals -->
      <div id="pendingReferrals" class="pending-referrals" style="display:none">
        <h4>Pending Referrals</h4>
        <div id="referralsList"></div>
      </div>
      
      <section class="card">
        <div class="hd">
          <strong>Assignment & Referrals</strong>
          <button class="btn2 primary small" onclick="saveAssignment()">
            <i data-lucide="save" class="btnIcon"></i> Save
          </button>
        </div>
        <div class="bd" style="display:grid;gap:16px">
          <div class="meta-item">
            <div class="meta-label">Underwriter</div>
            <select class="input" id="assignUW">
              <option>Marin Nikolla</option><option>Alex Morgan</option>
              <option>Priya Rao</option><option>Ben Turner</option>
            </select>
          </div>
          <div class="meta-item">
            <div class="meta-label">Underwriting Assistant</div>
            <select class="input" id="assignUA">
              <option>Jamie Lee</option><option>Sam Carter</option><option>Taylor Chen</option>
            </select>
          </div>

          <!-- Referral status -->
          <div style="padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="meta-label">Referral Status</div>
              <span id="refStatus" class="badge">None</span>
            </div>
            <button class="btn2 small" onclick="openReferral(true)" style="width:100%">
              <i data-lucide="share-2" class="btnIcon"></i> Refer to Underwriter
            </button>
          </div>

          <!-- Collapsible referral form -->
          <div id="refForm" class="section" style="display:none;background:#fff3cd;border-color:#f59e0b">
            <div class="meta-item">
              <div class="meta-label">Refer to Underwriter</div>
              <select id="refUW" class="input">
                <option value="">Select underwriter…</option>
                <option>Marin Nikolla</option><option>Alex Morgan</option><option>Priya Rao</option><option>Ben Turner</option>
              </select>
            </div>
            <div class="meta-item">
              <div class="meta-label">Reason for Referral</div>
              <select id="refReason" class="input">
                <option value="">Select reason…</option>
                <option>Outside appetite (borderline)</option>
                <option>Capacity/pricing guidance</option>
                <option>Referral—territory or class</option>
                <option>Complex terms/wordings</option>
                <option>Compliance / sanctions</option>
                <option value="peer_review">Peer Review</option>
              </select>
            </div>
            <div class="meta-item">
              <div class="meta-label">Additional Context</div>
              <textarea id="refComment" class="input" rows="3" placeholder="Add referral context…"></textarea>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn2 primary small" onclick="sendReferral()">
                <i data-lucide="send" class="btnIcon"></i> Send Referral
              </button>
              <button class="btn2 small" onclick="openReferral(false)">Cancel</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card collapsible">
        <div class="hd" onclick="toggleSection(this)">
          <div>
            <strong>Risk Recommendations</strong>
            <span class="section-summary" id="recs-summary"></span>
          </div>
          <i data-lucide="chevron-down" class="hd-icon"></i>
        </div>
        <div class="bd" id="recs" style="display:grid;gap:12px;font-size:13px">
          <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
            <button class="btn2 small" onclick="ackAll()">
              <i data-lucide="check-circle" class="btnIcon"></i> Acknowledge All
            </button>
          </div>
        </div>
      </section>

      <section class="card collapsible">
        <div class="hd" onclick="toggleSection(this)">
          <div>
            <strong>Document Management</strong>
            <span class="section-summary" id="docs-summary"></span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label class="btn2 small">
              <input id="docInput" type="file" multiple style="display:none" onchange="uploadDocs()">
              <i data-lucide="upload" class="btnIcon"></i> Upload
            </label>
            <i data-lucide="chevron-down" class="hd-icon"></i>
          </div>
        </div>
        <div class="bd" id="docs" class="list"></div>
      </section>
    </aside>
  </div>
</main>

<section class="card collapsible">
  <div class="hd" onclick="toggleSection(this)">
    <div>
      <strong>Wordings Template</strong>
      <span class="section-summary" id="wording-summary"></span>
    </div>
    <i data-lucide="chevron-down" class="hd-icon"></i>
  </div>
  <div class="bd" id="wordingBox">
    <!-- injected -->
  </div>
</section>


<!-- Actions Modal -->
<div class="modal" id="actionsModal">
  <div class="panel panel-lg">
    <div class="hd">
      <strong>Risk Actions</strong>
      <div class="actionsBar">
        <button class="btn2 small" onclick="showActionTab('decline')"><i data-lucide="x-octagon" class="btnIcon"></i> NTU / Decline</button>
        <button class="btn2 small" onclick="showActionTab('hold')"><i data-lucide="pause-circle" class="btnIcon"></i> Put on Hold</button>
        <button class="btn2 small" onclick="showActionTab('attest')"><i data-lucide="shield-check" class="btnIcon"></i> Attestations</button>
        <button class="btn2 small" onclick="openEditDrawer()"><i data-lucide="pencil" class="btnIcon"></i> Edit Risk</button>
        <button class="btn2 small" onclick="showActionTab('loss')"><i data-lucide="file-spreadsheet" class="btnIcon"></i> Loss runs</button>
        <button class="btn2" onclick="toggleActions(false)">Close</button>
      </div>
    </div>
    <div class="bd">
      <!-- Decline -->
      <div id="tab-decline" style="display:none">
        <div class="muted" style="margin-bottom:6px">Select reason and add comments.</div>
        <div style="display:grid;gap:10px;max-width:640px">
          <select id="declineReason" class="input">
            <option value="">Choose reason…</option>
            <option>Outside Appetite</option>
            <option>Insufficient Information</option>
            <option>Pricing / Capacity</option>
            <option>Sanctions / Compliance</option>
            <option>Conduct Risk Concern</option>
          </select>
          <textarea id="declineNotes" class="input" rows="4" placeholder="Additional comments…"></textarea>
          <button class="btn2 danger" onclick="confirmDecline()">Confirm NTU / Decline</button>
        </div>
      </div>

      <!-- Hold -->
      <div id="tab-hold" style="display:none">
        <div class="muted" style="margin-bottom:6px">Select duration or a specific until date.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn2 small" onclick="setHoldDays(7)">Hold 7d</button>
          <button class="btn2 small" onclick="setHoldDays(14)">Hold 14d</button>
          <button class="btn2 small" onclick="setHoldDays(30)">Hold 30d</button>
          <input id="holdUntil" class="input" type="date" />
        </div>
        <textarea id="holdNotes" class="input" rows="3" style="margin-top:8px" placeholder="Reason / next steps…"></textarea>
        <div style="margin-top:8px"><button class="btn2 primary" onclick="confirmHold()">Confirm Hold</button></div>
      </div>

      <!-- Attestations (fixed height scroll) -->
      <div id="tab-attest" style="display:none">
        <div class="muted" style="margin-bottom:10px">Record required controls with commentary and rationale (required).</div>
        <div class="attScroll">
          <section class="section">
            <strong>Sanctions</strong>
            <textarea id="sanctionsComment" class="input" rows="3" placeholder="Sanctions screening commentary…"></textarea>
            <input id="sanctionsRationale" class="input" placeholder="Rationale (required)"/>
            <button class="btn2 primary" onclick="attest('Sanctions')">Attest</button>
          </section>
          <section class="section">
            <strong>Conduct Risk</strong>
            <textarea id="conductComment" class="input" rows="3" placeholder="Conduct risk commentary…"></textarea>
            <input id="conductRationale" class="input" placeholder="Rationale (required)"/>
            <button class="btn2 primary" onclick="attest('Conduct Risk')">Attest</button>
          </section>
          <section class="section">
            <strong>ESG</strong>
            <textarea id="esgComment" class="input" rows="3" placeholder="ESG check commentary…"></textarea>
            <input id="esgRationale" class="input" placeholder="Rationale (required)"/>
            <button class="btn2 primary" onclick="attest('ESG')">Attest</button>
          </section>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loss Runs -->
<div id="tab-loss" style="display:none">
  <div class="muted" style="margin-bottom:6px">Edit last years’ loss runs. Add or remove rows as needed.</div>
  <div class="section">
    <table style="width:100%">
      <thead><tr>
        <th>Year</th><th>Claims</th><th>Paid</th><th>Outstanding</th><th>Notes</th><th></th>
      </tr></thead>
      <tbody id="lossEditBody"></tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button class="btn2 small" onclick="addLossRow()"><i data-lucide="plus" class="btnIcon"></i> Add row</button>
      <button class="btn2 primary small" onclick="saveLossEdits()"><i data-lucide="save" class="btnIcon"></i> Save loss runs</button>
    </div>
  </div>
</div>

<!-- Place after #tab-attest -->
<div id="tab-loss" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
    <div class="row">
      <label class="badge"><input id="lossEditToggle" type="checkbox" onchange="renderLossEdit()"> Edit mode</label>
      <button class="btn2 small" onclick="addLossRow()"><i data-lucide="plus" class="btnIcon"></i> Add row</button>
    </div>
    <div class="row">
      <button class="btn2" onclick="renderLossEdit(false)">Discard</button>
      <button class="btn2 primary" onclick="saveLossEdits()">Save</button>
    </div>
  </div>
  <div id="lossEditor"></div>
</div>

<!-- Edit Drawer -->
<aside id="editDrawer" class="drawer" aria-hidden="true">
  <div class="dhd">
    <strong>Edit Risk</strong>
    <div class="row">
      <button class="btn2" onclick="closeEditDrawer()">Cancel</button>
      <button class="btn2 primary" onclick="saveRiskEdits()">Save</button>
    </div>
  </div>
  <div class="dbd">
    <!-- Insureds -->
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Insureds</strong>
        <button class="btn2 small" onclick="addInsured()">Add Insured</button>
      </div>
      <div id="insuredsBox" class="list"></div>
    </div>

    <!-- Addresses -->
    <div class="section">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Addresses</strong>
        <button class="btn2 small" onclick="addAddress()">Add Address</button>
      </div>
      <div id="addressesBox" class="list"></div>
    </div>

    <!-- Policy -->
    <div class="section">
      <strong>Policy</strong>
      <div class="row">
        <input id="ed_inception" class="input" type="date" />
        <input id="ed_expiry" class="input" type="date" />
        <input id="ed_lob" class="input" placeholder="LOB (e.g., Property)"/>
        <input id="ed_product" class="input" placeholder="Product/Class (e.g., Hotels PAR)"/>
      </div>
      <div class="row">
        <select id="ed_placement" class="input">
          <option>Open Market</option><option>Co-Lead</option><option>Lead</option><option>Follow</option><option>Lineslip</option><option>Binder</option>
        </select>
        <input id="ed_domicile" class="input" placeholder="Domicile (country)"/>
        <select id="ed_currency" class="input"><option>USD</option><option>GBP</option><option>EUR</option></select>
      </div>
    </div>

    <!-- Limits & Lines -->
    <div class="section">
      <strong>Limits & Lines</strong>
      <div class="row">
        <input id="ed_exposure" class="input" type="number" placeholder="Exposure Limit (amount)"/>
        <input id="ed_written" class="input" type="number" step="0.01" placeholder="Written Line %"/>
        <input id="ed_signed" class="input" type="number" step="0.01" placeholder="Signed Line %"/>
        <input id="ed_commission" class="input" type="number" step="0.01" placeholder="Commission %"/>
      </div>
    </div>

    <!-- Broker -->
    <div class="section">
      <strong>Broker</strong>
      <div class="row">
        <input id="ed_broker_org" class="input" placeholder="Organisation"/>
        <input id="ed_broker_name" class="input" placeholder="Contact Name"/>
      </div>
      <div class="row">
        <input id="ed_broker_email" class="input" placeholder="Email"/>
        <input id="ed_broker_phone" class="input" placeholder="Phone"/>
        <select id="ed_broker_pick" class="input" onchange="pickBroker(this.value)">
          <option value="">Pick known…</option>
          <option value="Marsh Europe|Lucy Ward|lucy.ward@marsh.com|+44 20 1234 5678">Marsh Europe — Lucy Ward</option>
          <option value="Aon UK|James Porter|james.porter@aon.co.uk|+44 20 9876 5432">Aon UK — James Porter</option>
          <option value="Willis Towers Watson|Sarah Khan|sarah.khan@wtw.com|+44 20 2222 3333">WTW — Sarah Khan</option>
        </select>
      </div>
    </div>

    <!-- Change rationale (optional) -->
    <div class="section">
      <strong>Change Notes (optional)</strong>
      <textarea id="ed_reason" class="input" rows="3" placeholder="What changed and why? (added to timeline)"></textarea>
    </div>
  </div>
</aside>

<!-- Underwriter Notes Modal (revamped) -->
<div class="modal" id="notesModal">
  <div class="panel panel-lg" style="overflow:hidden">
    <div class="hd">
      <strong>Underwriter Notes</strong>
      <div class="actionsBar">
        <div class="row">
          <input id="noteFilter" class="input" placeholder="Filter by text or #tag…" style="min-width:280px">
          <button class="btn2 small" onclick="filterNotesUI()"><i data-lucide="search" class="btnIcon"></i> Filter</button>
          <button class="btn2 small" onclick="clearNotesFilter()">Clear</button>
        </div>
        <button class="btn2 small" onclick="popOutNotes()"><i data-lucide="external-link" class="btnIcon"></i> Pop out</button>
        <button class="btn2" onclick="toggleNotes(false)">Close</button>
      </div>
    </div>
    <div class="bd" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <!-- Composer -->
      <div class="section">
        <div class="notesHeader">
          <strong>Create / Edit</strong>
          <label class="badge"><input type="checkbox" id="notePinned"> Pin</label>
        </div>
        <input id="noteTitle" class="input" placeholder="Title"/>
        <textarea id="noteText" class="input" rows="8" placeholder="Write your note…"></textarea>
        <input id="noteTags" class="input" placeholder="Tags (comma-separated)"/>
        <div class="actionsBar" style="margin-top:8px">
          <label class="btn2 small"><input id="noteAttach" type="file" multiple style="display:none">Attach files</label>
          <button class="btn2 small" onclick="cleanNote()"><i data-lucide="wand-2" class="btnIcon"></i> AI Clean (placeholder)</button>
          <button class="btn2 primary" onclick="saveNote()"><i data-lucide="save" class="btnIcon"></i> Save</button>
        </div>
      </div>
      <!-- List -->
      <div class="section">
        <div class="notesHeader">
          <strong>Notes</strong>
          <span class="muted" style="font-size:12px">Newest first</span>
        </div>
        <div id="notesList" class="noteGrid muted">No notes yet.</div>
      </div>
    </div>
  </div>
</div>

<!-- Workflow Modal -->
<div class="modal" id="workflowModal" aria-hidden="true">
  <div class="panel panel-lg" style="overflow:hidden">
    <div class="hd">
      <strong>Workflow</strong>
      <div class="actionsBar">
        <button class="btn2" onclick="toggleWorkflow(false)">Close</button>
      </div>
    </div>
    <div class="bd" style="padding-bottom:0">
      <!-- Horizontal timeline -->
      <div class="wf-timeline">
        <div class="wf-line">
          <div id="wfLineFill" class="wf-line-fill" style="width:0%"></div>
        </div>
        <div id="wfStages" class="wf-stages"></div>
      </div>

      <!-- Free comment -->
      <div class="wf-section" style="margin-bottom:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Add commentary</strong>
          <span class="muted" style="font-size:12px">Saved to timeline</span>
        </div>
        <div class="row">
          <textarea id="wfFreeComment" class="input" rows="2" placeholder="Add context… e.g., why the stage changed, blockers, etc."></textarea>
          <button class="btn2 primary" onclick="wfAddFreeComment()">Save</button>
        </div>
      </div>

      <!-- Two-column checklists -->
      <div class="wf-col2">
        <div class="wf-section">
          <strong>Tasking</strong>
          <div id="wfTasking" class="list" style="margin-top:8px"></div>
        </div>
        <div class="wf-section">
          <strong>Items</strong>
          <div id="wfItems" class="list" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- confirmation bar -->
    <div id="wfConfirm" class="wf-confirm">
      <span class="muted" style="font-weight:700">Comment required</span>
      <textarea id="wfConfirmComment" class="input" placeholder="Describe the reason for this change…"></textarea>
      <button class="btn2" onclick="wfCancelPending()">Cancel</button>
      <button class="btn2 primary" onclick="wfConfirmPending()">Confirm</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Document Preview Modal -->
<div id="docModal" class="docModal">
  <div class="docModalContent">
    <div class="docModalHeader">
      <h3 id="docModalTitle">Document Preview</h3>
      <button class="docModalClose" onclick="closeDocModal()">&times;</button>
    </div>
    <div class="docModalBody" id="docModalBody">
      <!-- Document content will be loaded here -->
    </div>
  </div>
</div>

<script>
/* Icons */
lucide.createIcons();

/* ===== Sample risk data ===== */
const RISKS=[
 {id:'a8', insureds:[{name:'Silverline Hospitality', role:'Parent', primary:true}],
  broker:{org:'Marsh Europe', contact:'Lucy Ward', email:'lucy.ward@marsh.com', phone:'+44 20 1234 5678'},
  lob:'Property', product:'Hotels PAR', biz:'New', channel:'Broker',
  eff:'2025-10-12', exp:'2026-10-11', premium:880000, limits:'$250M Any One Occurrence', deductible:'$250k All Other Perils',
  occupancy:'Hotels', construction:'Masonry', sprinklered:true, lossRatio:28, priority:'High', stage:'Quoted',
  placement:'Open Market', domicile:'United Kingdom', currency:'USD', exposure:250000000, written:12.5, signed:10, commission:17.5,
  referrals:[
    {id:'ref1', to:'Alex Morgan', reason:'Capacity/pricing guidance', status:'Pending', ts:Date.now()-86400000, comment:'Need guidance on capacity allocation'},
    {id:'ref2', to:'Priya Rao', reason:'Peer Review', status:'Awaiting Peer Review', ts:Date.now()-43200000, comment:'Complex terms review required'}
  ],
  addresses:[
    {id:'L1', line1:'Hotel A, London, UK', lat:51.5074, lon:-0.1278, tiv:120000000, zone:'A', primary:true}, 
    {id:'L2', line1:'Hotel B, Manchester, UK', lat:53.4808, lon:-2.2426, tiv:80000000, zone:'B'},
    {id:'L3', line1:'Hotel C, Birmingham, UK', lat:52.4862, lon:-1.8904, tiv:50000000, zone:'B'}
  ],
  losses:[{year:'2021',claims:0,paid:0,os:0,note:'—'},{year:'2022',claims:1,paid:120000,os:0,note:'Kitchen fire — closed'},{year:'2023',claims:0,paid:0,os:0,note:'—'},{year:'2024',claims:1,paid:0,os:45000,note:'Water damage (open)'},{year:'2025',claims:0,paid:0,os:0,note:'—'}],
  recs:[
    {k:'Sanctions check completed', ok:true, tip:'No matches (Dow Jones)'},
    {k:'Appetite check', ok:true, tip:'HPR alignment'},
    {k:'ESG check', ok:false, tip:'Energy intensity—mitigation plan requested'},
    {k:'Risk clearance overlap', ok:true, tip:'No duplicate'},
    {k:'Multi-national candidate', ok:false, tip:'UK only'},
    {k:'Existing customer', ok:false, tip:'New account'},
    {k:'Broker approved', ok:true, tip:'Tier A broker'},
    {k:'Responsive broker', ok:true, tip:'Avg response 10h'},
    {k:'Jurisdiction check', ok:true, tip:'UK law'}
  ],
  docs:[{name:'Submission.pdf',class:'Submission'},{name:'LossRuns_2020-24.pdf',class:'Loss Runs'},{name:'SOV_Silverline.xlsx',class:'SOV'}]
 }
];

const USER='Marin Nikolla';
const $=s=>document.querySelector(s);
function qs(name){const p=new URLSearchParams(location.search);return p.get(name)||''}
function currency(n){return (+n).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0})}

/* ===== Risk load/save ===== */
const R = (()=>{ const id=qs('id')||'a8'; const base=RISKS.find(x=>x.id===id)||RISKS[0]; return loadRisk(base); })();
function loadRisk(base){ 
  try{ 
    const saved=JSON.parse(localStorage.getItem('risk_'+base.id)||'null'); 
    const result = saved ? saved : base;
    
    // Add sample audit data if none exists
    const auditKey = 'audit_' + result.id;
    if (!localStorage.getItem(auditKey)) {
      const sampleAudit = [
        {id:'e1', ts:Date.now()-86400000, user:'System', action:'Risk Submission', details:'Initial risk submission received from broker'},
        {id:'e2', ts:Date.now()-43200000, user:'Marin Nikolla', action:'Quote Generated', details:'Initial quote prepared and sent to broker'},
        {id:'e3', ts:Date.now()-21600000, user:'Marin Nikolla', action:'Workflow Stage Changed', details:'Moved to Underwriting Review'},
        {id:'e4', ts:Date.now()-10800000, user:'System', action:'Risk Bound', details:'Policy successfully bound and booked'},
        {id:'e5', ts:Date.now()-3600000, user:'Marin Nikolla', action:'Admin Update', details:'Updated risk details and documentation'}
      ];
      localStorage.setItem(auditKey, JSON.stringify(sampleAudit));
    }
    
    return result;
  }catch{ return base; } 
}
function saveRisk(obj){ localStorage.setItem('risk_'+obj.id, JSON.stringify(obj)); }

/* ===== Fill overview ===== */
function fillBasics(){
  $('#r_name').textContent=(R.insureds?.[0]?.name||'—')+' — '+(R.product||'');
  $('#r_insured').textContent=(R.insureds||[]).map(x=>x.name+(x.primary?' (Primary)':'' )).join(' • ');
  $('#r_broker').textContent=`${R.broker?.org||'—'} — ${R.broker?.contact||''} ${R.broker?.email?('('+R.broker.email+')'):''}`;
  $('#r_lob').textContent=R.lob||'—';
  $('#r_product').textContent=R.product||'—';
  $('#r_eff').textContent='Inception '+(R.eff||'—');
  $('#r_exp').textContent='Expiry '+(R.exp||'—');
  $('#r_premium').textContent='Est. '+currency(R.premium||0);
  $('#r_limits').textContent=R.limits||'—';
  $('#r_ded').textContent='Deductible '+(R.deductible||'—');
  $('#r_channel').textContent=R.channel||'—';
  $('#r_biz').textContent=R.biz||'—';
  $('#r_occ').textContent=R.occupancy||'—';
  $('#r_constr').textContent=R.construction||'—';
  $('#r_spk').textContent=R.sprinklered?'Yes':'No';
  $('#r_lr').textContent=(R.lossRatio??'—')+'%';
  $('#r_stage').textContent=R.stage||'—';
  $('#r_priority').textContent='Priority: '+(R.priority||'—');

  // details block
  $('#d_place').textContent=R.placement||'—';
  $('#d_dom').textContent=R.domicile||'—';
  $('#d_cur').textContent=R.currency||'—';
  $('#d_exp').textContent=currency(R.exposure||0);
  $('#d_wri').textContent=((R.written??0)+'%');
  $('#d_sig').textContent=((R.signed??0)+'%');
  $('#d_com').textContent=((R.commission??0)+'%');
  $('#d_bro').textContent=R.broker?.org||'—';
  $('#d_bro_contact').textContent=R.broker?.contact||'—';
  $('#d_bro_email').textContent=R.broker?.email||'—';
  $('#d_bro_phone').textContent=R.broker?.phone||'—';
  $('#d_construction').textContent=R.construction||'—';
  $('#d_occupancy').textContent=R.occupancy||'—';
  $('#d_sprinklered').textContent=R.sprinklered ? 'Yes' : 'No';
  $('#d_loss_ratio').textContent=R.lossRatio ? `${R.lossRatio}%` : '—';
}
function toggleDetails(){
  const el=$('#moreDetails'); el.classList.toggle('show');
}

/* ===== Loss history ===== */
function renderLoss(){
  const tb=$('#lossTbody');
  tb.innerHTML=(R.losses||[]).map(r=>`<tr><td>${r.year}</td><td>${r.claims}</td><td>${currency(r.paid)}</td><td>${currency(r.os)}</td><td>${r.note}</td></tr>`).join('');
}

/* ===== Recommendations (simplified, tidy) ===== */

/* state */
function recAckKey(){ return 'recAck_'+R.id; }
function loadRecAck(){ try{ return JSON.parse(localStorage.getItem(recAckKey())||'{}'); }catch{ return {}; } }
function saveRecAck(map){ localStorage.setItem(recAckKey(), JSON.stringify(map)); }

/* severity heuristic */
function recSeverity(k, ok){
  const K=(k||'').toLowerCase();
  if(K.includes('sanctions')) return ok?'Low':'High';
  if(K.includes('esg'))       return ok?'Low':'Medium';
  if(K.includes('multi'))     return ok?'Low':'Low';
  if(K.includes('clearance')) return ok?'Low':'Medium';
  if(K.includes('broker'))    return ok?'Low':'Medium';
  return ok?'Low':'Medium';
}

/* tiny CSS injected once for a clean layout */
function ensureRecStyles(){
  if(document.getElementById('recStyles')) return;
  const css = `
    .recList{display:grid;gap:6px;max-height:250px;overflow:auto;padding-right:4px}
    .recRow{display:flex;gap:8px;align-items:center;border:1px solid var(--border);
            border-radius:8px;padding:6px;background:#fff;transition:all 0.2s ease}
    .recRow.acknowledged{opacity:0.6;background:#f8f9fa;border-color:#e9ecef}
    .recRow.acknowledged .recTitle{color:#6c757d;text-decoration:line-through}
    .recRow.acknowledged .recTip{color:#adb5bd}
    .sev{width:8px;height:8px;border-radius:999px}
    .sev.low{background:#22C55E}.sev.medium{background:#F59E0B}.sev.high{background:#EF4444}
    .recMain{flex:1;min-width:0}
    .recTitle{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px}
    .recTip{color:var(--muted);font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:10px}
    .recActions{display:flex;gap:4px}
    .recBtn{display:inline-flex;align-items:center;gap:2px;padding:2px 4px;border-radius:4px;border:1px solid var(--border);background:#fff;font-size:9px;cursor:pointer;transition:all 0.2s ease}
    .recBtn:hover{background:#f8f9fa}
    .recBtn.acknowledged{background:#6c757d;color:#fff;border-color:transparent;opacity:0.8}
  `;
  const style=document.createElement('style');
  style.id='recStyles'; style.textContent=css; document.head.appendChild(style);
}

function recStatusBadge(ok){
  const bg=ok?'#E8F5E9':'#FFF3E0', fg=ok?'#1B5E20':'#C2410C';
  return `<span class="pill" style="background:${bg};color:${fg}">${ok?'OK':'Check'}</span>`;
}

/* render */
function renderRecs(){
  ensureRecStyles();
  const box = document.getElementById('recs');
  const ack  = loadRecAck();
  const items = (R.recs||[]).map(r=>({ ...r, sev:(r.sev||recSeverity(r.k,r.ok)).toLowerCase(), ack:!!ack[r.k] }));

  box.innerHTML = `
    <div class="recList">
      ${items.map(r => `
        <div class="recRow ${r.ack ? 'acknowledged' : ''}">
          <span class="sev ${r.sev}"></span>
          <div class="recMain">
            <div class="recTitle">${r.k}</div>
            ${r.tip ? `<div class="recTip">${r.tip}</div>` : ``}
          </div>
          <div class="pill">${recStatusBadge(r.ok)}</div>
          <div class="recActions">
            ${r.ok ? `` : `<button class="recBtn" onclick="reqInfo('${r.k}')">Info</button>`}
            <button class="recBtn ${r.ack ? 'acknowledged' : ''}" onclick="toggleRecAck('${r.k}',${!r.ack})">
              ${r.ack?'✓':'○'} Ack
            </button>
          </div>
        </div>`).join('')}
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <button class="btn2 small" onclick="ackAll()">Acknowledge all</button>
    </div>`;
  if(window.lucide) lucide.createIcons();
  
  // Update summary if section is collapsed
  const recsCard = document.querySelector('#recs').closest('.collapsible');
  if (recsCard && recsCard.querySelector('.bd').classList.contains('collapsed')) {
    updateSectionSummary(recsCard);
  }
}

/* actions */
function toggleRecAck(k,val){ const m=loadRecAck(); m[k]=!!val; saveRecAck(m); renderRecs(); }
function ackAll(){ const m={}; (R.recs||[]).forEach(r=>m[r.k]=true); saveRecAck(m); renderRecs(); }
function reqInfo(k){ addAudit('Info requested', k); chipToast('Info request logged'); }

/* ===== Documents ===== */
let DOCS = [...(R.docs||[])];
function persistDocs(){ localStorage.setItem('docs_'+R.id, JSON.stringify(DOCS)); }
function loadDocs(){ try{ DOCS=JSON.parse(localStorage.getItem('docs_'+R.id))||DOCS; }catch{} }
function renderDocs(){
  const box=$('#docs'); if(!DOCS.length){ box.innerHTML='<div class="muted">No documents.</div>'; return; }
  box.innerHTML = DOCS.map((d,i)=>`
    <div class="docRow" onclick="previewDocument(${i})">
      <div class="docPreview">
        <i data-lucide="${getFileIcon(d.name)}" class="btnIcon"></i>
      </div>
      <div class="docInfo">
        <div class="docName">${d.name}</div>
        <div class="docMeta">${d.class||'—'} • ${formatFileSize(d.size)} • ${new Date(d.uploaded || Date.now()).toLocaleDateString()}</div>
        <div class="docTags">
          ${(d.tags || []).map(tag => `<span class="docTag">${tag}</span>`).join('')}
        </div>
      </div>
      <div class="docActions">
        <div class="doc-class-dropdown">
          <button class="doc-class-btn" onclick="event.stopPropagation(); toggleClassDropdown(${i})" title="Change Classification">
            <i data-lucide="folder" class="btnIcon"></i>
            <i data-lucide="chevron-down" class="btnIcon" style="width:12px;height:12px"></i>
          </button>
          <div class="doc-class-menu" id="classMenu_${i}">
            ${['Submission','SOV','Loss Runs','Engineering','Financials','Other'].map(cls => 
              `<div class="doc-class-item ${d.class === cls ? 'selected' : ''}" onclick="setDocClass(${i}, '${cls}')">${cls}</div>`
            ).join('')}
          </div>
        </div>
        <button class="docBtn" onclick="event.stopPropagation(); addDocTag(${i})" title="Add Tag">
          <i data-lucide="tag" class="btnIcon"></i>
        </button>
        <button class="docBtn" onclick="event.stopPropagation(); delDoc(${i})" title="Delete">
          <i data-lucide="trash" class="btnIcon"></i>
        </button>
      </div>
    </div>`).join('');
  if(window.lucide) lucide.createIcons();
  
  // Update summary if section is collapsed
  const docsCard = document.querySelector('#docs').closest('.collapsible');
  if (docsCard && docsCard.querySelector('.bd').classList.contains('collapsed')) {
    updateSectionSummary(docsCard);
  }
}
function setDocClass(i,val){ 
  DOCS[i].class=val; 
  persistDocs(); 
  renderDocs();
  // Close the dropdown
  document.getElementById(`classMenu_${i}`).classList.remove('show');
}
function delDoc(i){ if(!confirm('Delete this document?')) return; DOCS.splice(i,1); persistDocs(); renderDocs(); }
function uploadDocs(){
  const input=$('#docInput');
  const files=[...input.files];
  files.forEach(f=>DOCS.push({
    name:f.name,
    class:'Other',
    size:f.size,
    uploaded:Date.now(),
    tags:[],
    file:f
  }));
  input.value=''; persistDocs(); renderDocs();
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (['pdf'].includes(ext)) return 'file-text';
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'image';
  if (['doc', 'docx'].includes(ext)) return 'file-text';
  if (['xls', 'xlsx'].includes(ext)) return 'table';
  if (['ppt', 'pptx'].includes(ext)) return 'presentation';
  return 'file';
}

function formatFileSize(bytes) {
  if (!bytes) return 'Unknown size';
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
}

function previewDocument(index) {
  const doc = DOCS[index];
  if (!doc) return;
  
  const modal = document.getElementById('docModal');
  const title = document.getElementById('docModalTitle');
  const body = document.getElementById('docModalBody');
  
  title.textContent = doc.name;
  
  // Create preview content based on file type
  const ext = doc.name.split('.').pop().toLowerCase();
  let previewContent = '';
  
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) {
    if (doc.file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewContent = `<img src="${e.target.result}" style="max-width:100%;height:auto;border-radius:8px">`;
        body.innerHTML = previewContent;
      };
      reader.readAsDataURL(doc.file);
    } else {
      previewContent = '<div class="muted">Image preview not available</div>';
    }
  } else if (ext === 'pdf') {
    if (doc.file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewContent = `<iframe src="${e.target.result}" style="width:100%;height:600px;border:none;border-radius:8px"></iframe>`;
        body.innerHTML = previewContent;
      };
      reader.readAsDataURL(doc.file);
    } else {
      previewContent = '<div class="muted">PDF preview not available</div>';
    }
  } else {
    previewContent = `
      <div style="text-align:center;padding:40px">
        <i data-lucide="${getFileIcon(doc.name)}" style="width:64px;height:64px;color:#6b7280;margin-bottom:16px"></i>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">${doc.name}</div>
        <div class="muted">Preview not available for this file type</div>
        <div style="margin-top:16px">
          <button class="btn2" onclick="downloadDocument(${index})">
            <i data-lucide="download" class="btnIcon"></i> Download
          </button>
        </div>
      </div>
    `;
  }
  
  if (!['jpg', 'jpeg', 'png', 'gif', 'bmp', 'pdf'].includes(ext) || !doc.file) {
    body.innerHTML = previewContent;
  }
  
  modal.classList.add('show');
  if(window.lucide) lucide.createIcons();
}

function closeDocModal() {
  document.getElementById('docModal').classList.remove('show');
}

function addDocTag(index) {
  const tag = prompt('Enter tag name:');
  if (tag && tag.trim()) {
    if (!DOCS[index].tags) DOCS[index].tags = [];
    if (!DOCS[index].tags.includes(tag.trim())) {
      DOCS[index].tags.push(tag.trim());
      persistDocs();
      renderDocs();
    }
  }
}

function downloadDocument(index) {
  const doc = DOCS[index];
  if (doc.file) {
    const url = URL.createObjectURL(doc.file);
    const a = document.createElement('a');
    a.href = url;
    a.download = doc.name;
    a.click();
    URL.revokeObjectURL(url);
  }
}

/* ===== Collapsible Sections ===== */
function toggleSection(header) {
  const card = header.closest('.collapsible');
  const body = card.querySelector('.bd');
  const icon = header.querySelector('.hd-icon');
  
  if (body.classList.contains('collapsed')) {
    body.classList.remove('collapsed');
    header.classList.remove('collapsed');
    icon.style.transform = 'rotate(0deg)';
  } else {
    body.classList.add('collapsed');
    header.classList.add('collapsed');
    icon.style.transform = 'rotate(180deg)';
    updateSectionSummary(card);
  }
}

function updateSectionSummary(card) {
  const sectionId = card.id || card.querySelector('[id]')?.id;
  const summaryEl = card.querySelector('.section-summary');
  if (!summaryEl) return;
  
  let summary = '';
  
  if (sectionId === 'sovCard') {
    // Locations, SOV & Flood summary
    const addresses = R.addresses || [];
    const totalTIV = addresses.reduce((sum, addr) => sum + (addr.tiv || 0), 0);
    summary = `${addresses.length} locations • £${(totalTIV/1000000).toFixed(1)}M TIV`;
  } else if (card.querySelector('#recs')) {
    // Risk Recommendations summary
    const recs = RECS || [];
    const ackCount = recs.filter(r => r.ack).length;
    summary = `${recs.length} recommendations • ${ackCount} acknowledged`;
  } else if (card.querySelector('#docs')) {
    // Document Management summary
    const docs = DOCS || [];
    const classified = docs.filter(d => d.class).length;
    summary = `${docs.length} documents • ${classified} classified`;
  } else if (card.querySelector('#lossTbody')) {
    // Loss History summary
    const lossData = R.lossHistory || [];
    const totalClaims = lossData.reduce((sum, year) => sum + (year.claims || 0), 0);
    const totalPaid = lossData.reduce((sum, year) => sum + (year.paid || 0), 0);
    summary = `${lossData.length} years • ${totalClaims} claims • £${(totalPaid/1000).toFixed(0)}k paid`;
  } else if (card.querySelector('#attLog')) {
    // Compliance & Attestations summary
    const atts = R.attestations || [];
    const completed = atts.filter(a => a.completed).length;
    summary = `${atts.length} attestations • ${completed} completed`;
  } else if (card.querySelector('#wordingBox')) {
    // Wordings Template summary
    const wordings = R.wordings || [];
    const active = wordings.filter(w => w.active).length;
    summary = `${wordings.length} templates • ${active} active`;
  }
  
  summaryEl.textContent = summary;
}

/* ===== Document Classification Dropdown ===== */
function toggleClassDropdown(index) {
  // Close all other dropdowns
  document.querySelectorAll('.doc-class-menu').forEach(menu => {
    if (menu.id !== `classMenu_${index}`) {
      menu.classList.remove('show');
    }
  });
  
  // Toggle current dropdown
  const menu = document.getElementById(`classMenu_${index}`);
  const button = menu.previousElementSibling;
  
  if (menu.classList.contains('show')) {
    menu.classList.remove('show');
  } else {
    // Position the dropdown relative to the button
    const buttonRect = button.getBoundingClientRect();
    menu.style.top = `${buttonRect.bottom + window.scrollY}px`;
    menu.style.left = `${buttonRect.right - 120 + window.scrollX}px`; // 120px is min-width
    menu.classList.add('show');
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.doc-class-dropdown')) {
    document.querySelectorAll('.doc-class-menu').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

/* ===== Assignment ===== */
function saveAssignment(){ addAudit('Assignment saved', `UW=${$('#assignUW').value}, UA=${$('#assignUA').value}`); chipToast('Assignment saved'); }

/* ===== Referral (Assignment) ===== */
function refKey(){ return 'ref_'+R.id; }
function loadRef(){ try{ return JSON.parse(localStorage.getItem(refKey())||'null'); }catch{ return null; } }
function saveRef(obj){ localStorage.setItem(refKey(), JSON.stringify(obj)); }
function openReferral(show){
  const box = document.getElementById('refForm');
  if (!box) return;
  box.style.display = show ? 'block' : 'none';
  if (show) {
    // prefill recipient = current UW, if any
    const uw = document.getElementById('assignUW')?.value || '';
    if (uw && document.getElementById('refUW')) document.getElementById('refUW').value = uw;
  }
}
function renderReferralStatus(){
  const el = document.getElementById('refStatus'); if(!el) return;
  const ref = loadRef();
  if(!ref){ el.textContent = 'None'; el.style.background=''; el.style.color='inherit'; return; }
  
  if(ref.status === 'Awaiting Peer Review') {
    el.textContent = `Awaiting Peer Review → ${ref.to}`;
    el.style.background = '#dbeafe'; el.style.color = '#1e40af'; // blue
  } else {
    el.textContent = `Pending → ${ref.to}`;
    el.style.background = '#FEF3C7'; el.style.color = '#92400E'; // amber
  }
}

function renderPendingReferrals(){
  const container = document.getElementById('pendingReferrals');
  const list = document.getElementById('referralsList');
  if(!container || !list) return;
  
  const referrals = R.referrals || [];
  const pendingReferrals = referrals.filter(r => r.status === 'Pending' || r.status === 'Awaiting Peer Review');
  
  if(pendingReferrals.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  list.innerHTML = pendingReferrals.map(ref => {
    const statusClass = ref.status === 'Awaiting Peer Review' ? 'peer-review' : 'pending';
    const when = new Date(ref.ts).toLocaleString();
    return `
      <div class="referral-item">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span class="referral-status ${statusClass}">${ref.status}</span>
          <span style="font-size:10px;color:#6b7280">${when}</span>
        </div>
        <div style="font-weight:600;margin-bottom:2px">To: ${ref.to}</div>
        <div style="color:#6b7280;font-size:11px;margin-bottom:4px">${ref.reason}</div>
        ${ref.comment ? `<div style="color:#374151;font-size:11px;font-style:italic">${ref.comment}</div>` : ''}
      </div>
    `;
  }).join('');
}
function sendReferral(){
  const to = document.getElementById('refUW').value.trim();
  const reason = document.getElementById('refReason').value.trim();
  const comment = document.getElementById('refComment').value.trim();
  if(!to || !reason){ alert('Please select an underwriter and a reason.'); return; }
  
  // Set status based on referral type
  const status = reason === 'peer_review' ? 'Awaiting Peer Review' : 'Pending';
  const displayReason = reason === 'peer_review' ? 'Peer Review' : reason;
  
  const payload = { status, to, reason: displayReason, comment, ts:Date.now() };
  saveRef(payload);
  
  // Add to referrals array
  if (!R.referrals) R.referrals = [];
  R.referrals.push({
    id: 'ref' + Date.now(),
    to,
    reason: displayReason,
    status,
    comment,
    ts: Date.now()
  });
  saveRisk(R);
  
  renderReferralStatus();
  renderPendingReferrals();
  addAudit('Referral raised', `To ${to} • ${displayReason} • ${comment||'—'}`);
  chipToast('Referral sent'); openReferral(false);
}

/* ===== JS Helpers ===== */
function loadWordingTemplates(){
  try{ const s=localStorage.getItem('wording_templates'); if(s) return JSON.parse(s); }catch{}
  // Fallback seed set
  return [
    {id:'lma-3092', name:'LMA 3092 — Property', approved:true, tags:['LMA','Property','Std']},
    {id:'par-hotels-v2', name:'PAR — Hotels v2', approved:false, tags:['Property','Hotels']},
    {id:'custom-2025-hpr', name:'Custom HPR 2025', approved:true, tags:['HPR']}
  ];
}
function renderWordingPicker(){
  const box=document.getElementById('wordingBox'); if(!box) return;
  const leadish = (R.placement||'').toLowerCase().includes('lead');
  const tpls = loadWordingTemplates();
  const current = R.wordingTemplate || '';

  if(!leadish){
    box.innerHTML = `<div class="muted">Placement is <strong>${R.placement||'—'}</strong>. Wordings selection enabled for Lead / Co-Lead only.</div>`;
    return;
  }
  box.innerHTML = `
    <div class="row">
      <select id="wordingSelect" class="input" style="min-width:260px">
        <option value="">Select a template…</option>
        ${tpls.map(t=>`<option value="${t.id}" ${t.id===current?'selected':''}>${t.name}${t.approved?' (Approved)':''}</option>`).join('')}
      </select>
      <button class="btn2 small" onclick="previewWording()"><i data-lucide='eye' class='btnIcon'></i> Preview</button>
      <button class="btn2 primary small" onclick="saveWordingSel()"><i data-lucide='save' class='btnIcon'></i> Use</button>
    </div>
    <div class="muted" style="font-size:12px;margin-top:6px">Templates from Toolkit. Approved templates are marked.</div>`;
  if(window.lucide) lucide.createIcons();
}
function saveWordingSel(){
  const id=document.getElementById('wordingSelect').value;
  R.wordingTemplate = id || '';
  saveRisk(R);
  addAudit('Wording template selected', id||'None');
  chipToast('Wordings updated');
}
function previewWording(){
  const id=document.getElementById('wordingSelect').value;
  if(!id){ alert('Select a template first'); return; }
  const tpl=(loadWordingTemplates().find(t=>t.id===id))||{name:'Template', approved:false};
  const w=window.open('', 'wording_'+id, 'width=900,height=680,noopener');
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>${tpl.name}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>body{font-family:Inter,system-ui;margin:0;padding:20px;background:#fff;color:#111} h1{margin:0 0 4px} .muted{color:#6B757E} pre{white-space:pre-wrap;border:1px solid #E6E9EE;border-radius:12px;padding:12px}</style>
    </head><body>
      <h1>${tpl.name}</h1>
      <div class="muted">${tpl.approved?'Approved':'Pending approval'} • preview</div>
      <pre>[Sample wording body… placeholder for clause library / LMA text.]</pre>
    </body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}


function handleWorkflowClick(){
  // Prefer the external API if present
  if (typeof window.openWorkflow === 'function') {
    window.openWorkflow();
    return;
  }
  // Fallback: render then show the modal
  if (typeof window.renderWorkflow === 'function') {
    window.renderWorkflow();
  }
  const m = document.getElementById('workflowModal');
  if (m) m.style.display = 'flex';
}

function init(){
  fillBasics(); renderLoss(); renderRecs();
  loadDocs(); renderDocs();
  renderAtt();
  renderReferralStatus();
  renderPendingReferrals();
  renderTimeline();
  renderSOV();
  initMap();
}


/* --- Actions --- */
function showActionTab(t){
  ['decline','hold','attest','loss'].forEach(x=>{
    const el=document.getElementById('tab-'+x);
    if(el) el.style.display=(x===t?'block':'none');
  });
  if(t==='loss'){ renderLossEdit(); }
  if(window.lucide) lucide.createIcons();
}

function renderLossEdit(){
  const edit = document.getElementById('lossEditToggle')?.checked;
  const box = document.getElementById('lossEditor');
  const rows = (R.losses||[]).map((r,i)=> edit ? `
    <tr>
      <td><input class="input" style="width:90px" value="${r.year}"></td>
      <td><input class="input" style="width:80px" type="number" value="${r.claims}"></td>
      <td><input class="input" style="width:140px" type="number" value="${r.paid}"></td>
      <td><input class="input" style="width:140px" type="number" value="${r.os}"></td>
      <td><input class="input" style="width:100%" value="${r.note||''}"></td>
      <td><button class="btn2 small" onclick="deleteLossRow(${i})">Delete</button></td>
    </tr>` : `
    <tr>
      <td>${r.year}</td><td>${r.claims}</td>
      <td>${currency(r.paid)}</td><td>${currency(r.os)}</td><td>${r.note||''}</td><td></td>
    </tr>`
  ).join('');

  box.innerHTML = `
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Year</th><th>Claims</th><th>Paid</th><th>Outstanding</th><th>Notes</th><th></th></tr></thead>
        <tbody id="lossEditBody">${rows}</tbody>
      </table>
    </div>`;
}

function addLossRow(){
  (R.losses=R.losses||[]).unshift({year:new Date().getFullYear().toString(),claims:0,paid:0,os:0,note:''});
  renderLossEdit();
}
function deleteLossRow(i){ R.losses.splice(i,1); renderLossEdit(); }
function saveLossEdits(){
  const edit = document.getElementById('lossEditToggle')?.checked;
  if(!edit){ chipToast('Nothing to save'); return; }
  const trs=[...document.querySelectorAll('#lossEditBody tr')];
  const next = trs.map(tr=>{
    const [yr,cl,pa,os,no] = [...tr.querySelectorAll('input')].map(i=>i.value);
    return {year:String(yr||''), claims:+cl||0, paid:+pa||0, os:+os||0, note:no||''};
  });
  R.losses = next;
  saveRisk(R);
  renderLoss();
  addAudit('Loss runs updated', `${next.length} rows saved`);
  chipToast('Loss runs saved');
}


/* ===== Timeline (left) ===== */
let AUDIT_PAGE = 1; // how many pages of events to show
function aKey(){ return 'audit_'+R.id; }
function loadAudit(){ try{ return JSON.parse(localStorage.getItem(aKey())||'[]'); }catch{ return []; } }
function saveAudit(list){ localStorage.setItem(aKey(), JSON.stringify(list)); renderTimeline(); }
function addAudit(action, details){
  const list = loadAudit();
  list.unshift({id:'e'+Date.now(), ts:Date.now(), user:USER, action, details});
  saveAudit(list);
  chipToast(`${action} recorded`);
}
function tColor(action){
  const a = (action||'').toLowerCase();
  if(a.includes('decline')||a.includes('ntu')) return 'dot-red';
  if(a.includes('hold')) return 'dot-amber';
  if(a.includes('attest')) return 'dot-blue';
  if(a.includes('workflow stage')) return 'dot-purple';
  if(a.includes('edited')||a.includes('assignment')) return 'dot-green';
  return 'dot-grey';
}
let timelineMode = 'detailed'; // 'standard' or 'detailed'
let timelinePage = 0;
let timelinePageSize = 5;

function navigateTimeline(direction) {
  const filteredEvents = getFilteredEvents();
  const totalPages = Math.ceil(filteredEvents.length / timelinePageSize);
  
  // Clamp timelinePage to valid range
  timelinePage = Math.max(0, Math.min(timelinePage + direction, totalPages - 1));
  
  renderTimeline();
}

function getFilteredEvents() {
  const list = loadAudit();
  const slice = list.slice(0, AUDIT_PAGE * 18);
  
  if (timelineMode === 'standard') {
    return slice.filter(ev => {
      const action = ev.action.toLowerCase();
      return ['submission', 'quote', 'bind', 'booked', 'decline', 'approve', 'workflow stage'].some(stage => 
        action.includes(stage));
    });
  }
  return slice;
}

function toggleTimelineView() {
  timelineMode = timelineMode === 'standard' ? 'detailed' : 'standard';
  timelinePage = 0; // Reset to first page when switching views
  const toggle = document.getElementById('timelineToggle');
  const icon = toggle.querySelector('i');
  
  if (timelineMode === 'standard') {
    icon.setAttribute('data-lucide', 'list');
    toggle.innerHTML = '<i data-lucide="list" class="btnIcon"></i> Standard';
    document.getElementById('timelineBox').classList.add('standard-view');
  } else {
    icon.setAttribute('data-lucide', 'activity');
    toggle.innerHTML = '<i data-lucide="activity" class="btnIcon"></i> Detailed';
    document.getElementById('timelineBox').classList.remove('standard-view');
  }
  
  lucide.createIcons();
  renderTimeline();
}

function getEventCategory(action) {
  const a = (action || '').toLowerCase();
  if (a.includes('submission') || a.includes('quote') || a.includes('bind') || a.includes('booked')) {
    return 'stage-event';
  }
  if (a.includes('admin') || a.includes('created') || a.includes('updated') || a.includes('assigned')) {
    return 'admin';
  }
  if (a.includes('decline') || a.includes('approve') || a.includes('decision') || a.includes('ntu')) {
    return 'decision';
  }
  if (a.includes('edit') || a.includes('adjust') || a.includes('modify') || a.includes('change')) {
    return 'adjustment';
  }
  return 'admin';
}

function renderTimeline(){
  const box = document.getElementById('timelineBox');
  const nav = document.getElementById('timelineNav');
  if (!box) { console.error('Timeline box not found'); return; }
  
  const filteredEvents = getFilteredEvents();
  const totalPages = Math.ceil(filteredEvents.length / timelinePageSize);
  
  if(!filteredEvents.length){ 
    box.innerHTML = '<div class="muted">No events yet.</div>'; 
    if (nav) nav.style.display = 'none';
    return; 
  }
  
  // Show/hide navigation based on whether pagination is needed
  if (nav) {
    nav.style.display = totalPages > 1 ? 'flex' : 'none';
  }
  
  // Get current page events
  const startIndex = timelinePage * timelinePageSize;
  const endIndex = startIndex + timelinePageSize;
  const pageEvents = filteredEvents.slice(startIndex, endIndex);
  
  console.log('Rendering timeline page:', timelinePage, 'of', totalPages, 'events:', pageEvents.length);
  
  box.innerHTML = pageEvents.map(ev=>{
    const when = new Date(ev.ts).toLocaleString();
    const dot = tColor(ev.action);
    const category = getEventCategory(ev.action);
    const body = ev.details ? `<div class="evtBody">${ev.details}</div>` : '';
    return `<div class="titem">
      <span class="dot ${dot}"></span>
      <div class="evt ${category}" onclick="this.classList.toggle('show')">
        <div class="evtHead"><strong>${ev.action}</strong><span class="evtTime">${when} • ${ev.user}</span></div>
        ${body}
      </div>
    </div>`;
  }).join('');
  
  // Update navigation chevrons
  const prevChevron = document.getElementById('prevTimeline');
  const nextChevron = document.getElementById('nextTimeline');
  if (prevChevron) prevChevron.style.pointerEvents = timelinePage <= 0 ? 'none' : 'auto';
  if (nextChevron) nextChevron.style.pointerEvents = timelinePage >= totalPages - 1 ? 'none' : 'auto';
}
function loadMoreAudit(){ AUDIT_PAGE++; renderTimeline(); }

/* ===== Map (Leaflet) ===== */
let map, markersLayer, ukFlood, usFlood;
function center(){
  const pts=(R.addresses||[]).filter(a=>a.lat&&a.lon);
  if(!pts.length) return null;
  const lat=pts.reduce((s,p)=>s+p.lat,0)/pts.length;
  const lon=pts.reduce((s,p)=>s+p.lon,0)/pts.length;
  return {lat,lon};
}
function isUK(){ const c=center(); return c && c.lat>49 && c.lat<60 && c.lon>-8 && c.lon<2; }
function isUS(){ const c=center(); return c && c.lat>24 && c.lat<49 && c.lon<-66 && c.lon>-125; }

function initMap(){
  try {
    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.error('Map container not found');
      return;
    }

    // Initialize map with better options
    map = L.map('map', {
      attributionControl: true, 
      zoomControl: true,
      preferCanvas: true
    });

    // Add base layer
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, 
      attribution: '&copy; OpenStreetMap contributors'
    });
    osm.addTo(map);

    // Initialize markers layer
    markersLayer = L.layerGroup().addTo(map);

    // Set initial view based on addresses
    const pts = (R.addresses || []).filter(a => a.lat && a.lon).map(a => [a.lat, a.lon]);
    if (pts.length) { 
      map.fitBounds(pts, {padding: [30, 30]}); 
      console.log('Map centered on addresses:', pts.length);
    } else { 
      // Default to London if no addresses
      map.setView([51.5074, -0.1278], 6); 
      console.log('Map set to default view (London)');
    }

    // Set up flood overlay toggles
    const ukToggle = document.getElementById('ukFloodToggle');
    const usToggle = document.getElementById('usFloodToggle');
    
    if (ukToggle && usToggle) {
      ukToggle.checked = isUK();
      usToggle.checked = isUS();

      ukToggle.addEventListener('change', () => toggleUKFlood(ukToggle.checked));
      usToggle.addEventListener('change', () => toggleUSFlood(usToggle.checked));

      // Auto-enable flood overlays based on location
      if (ukToggle.checked) toggleUKFlood(true);
      if (usToggle.checked) toggleUSFlood(true);
    }

    // Render markers
    renderMarkers();
    
    console.log('Map initialized successfully');
  } catch (e) {
    console.error('Map initialization error:', e);
    chipToast('Map failed to load');
  }
}
function renderMarkers(){
  if (!markersLayer) {
    console.warn('Markers layer not initialized');
    return;
  }
  
  markersLayer.clearLayers();
  const addresses = R.addresses || [];
  console.log('Rendering markers for addresses:', addresses);
  
  addresses.forEach(a => {
    if (!(a.lat && a.lon)) {
      console.log('Skipping address without coordinates:', a);
      return;
    }
    
    const m = L.marker([a.lat, a.lon], {title: a.line1});
    m.on('click', () => selectRow(a.id, true));
    m.addTo(markersLayer);
    console.log('Added marker for:', a.line1, 'at', a.lat, a.lon);
  });
  
  console.log('Total markers rendered:', markersLayer.getLayers().length);
}
function toggleUKFlood(on){
  try{
    if(on){
      // Remove existing layer if any
      if(ukFlood){ map.removeLayer(ukFlood); ukFlood=null; }
      
      // Try multiple UK flood data sources
      const floodSources = [
        {
          url: 'https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea/wms',
          options: {
            layers: 'FloodMapForPlanning_RiversAndSea_FloodZone3,FloodMapForPlanning_RiversAndSea_FloodZone2',
            format: 'image/png',
            transparent: true,
            opacity: 0.6,
            maxZoom: 18,
            attribution: 'Environment Agency'
          }
        },
        {
          url: 'https://environment.data.gov.uk/spatialdata/flood-map-for-planning-rivers-and-sea/wms',
          options: {
            layers: 'FloodMapForPlanning_RiversAndSea_FloodZone3',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            maxZoom: 16,
            attribution: 'Environment Agency'
          }
        }
      ];
      
      // Try the first source
      ukFlood = L.tileLayer.wms(floodSources[0].url, floodSources[0].options);
      
      // Add error handling for the layer
      ukFlood.on('tileerror', function(e) {
        console.warn('UK Flood tile error, trying alternative source');
        if (map.hasLayer(ukFlood)) {
          map.removeLayer(ukFlood);
        }
        ukFlood = L.tileLayer.wms(floodSources[1].url, floodSources[1].options);
        ukFlood.addTo(map);
      });
      
      ukFlood.addTo(map);
      chipToast('UK Flood overlay on');
    } else { 
      if(ukFlood){ 
        map.removeLayer(ukFlood); 
        ukFlood=null; 
        chipToast('UK Flood overlay off'); 
      } 
    }
  }catch(e){ 
    console.warn('UK Flood overlay error:', e); 
    chipToast('UK Flood overlay unavailable'); 
    if(document.getElementById('ukFloodToggle')) document.getElementById('ukFloodToggle').checked=false; 
  }
}
function toggleUSFlood(on){
  try{
    if(on){
      // Remove existing layer if any
      if(usFlood){ map.removeLayer(usFlood); usFlood=null; }
      
      // Try multiple US flood data sources
      const floodSources = [
        {
          url: 'https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/WMSServer',
          options: {
            layers: '0,28',
            format: 'image/png',
            transparent: true,
            opacity: 0.6,
            maxZoom: 18,
            attribution: 'FEMA'
          }
        },
        {
          url: 'https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer/WMSServer',
          options: {
            layers: '0',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            maxZoom: 16,
            attribution: 'FEMA'
          }
        }
      ];
      
      // Try the first source
      usFlood = L.tileLayer.wms(floodSources[0].url, floodSources[0].options);
      
      // Add error handling for the layer
      usFlood.on('tileerror', function(e) {
        console.warn('US FEMA tile error, trying alternative source');
        if (map.hasLayer(usFlood)) {
          map.removeLayer(usFlood);
        }
        usFlood = L.tileLayer.wms(floodSources[1].url, floodSources[1].options);
        usFlood.addTo(map);
      });
      
      usFlood.addTo(map);
      chipToast('US FEMA overlay on');
    } else { 
      if(usFlood){ 
        map.removeLayer(usFlood); 
        usFlood=null; 
        chipToast('US FEMA overlay off'); 
      } 
    }
  }catch(e){ 
    console.warn('US FEMA overlay error:', e); 
    chipToast('US FEMA overlay unavailable'); 
    if(document.getElementById('usFloodToggle')) document.getElementById('usFloodToggle').checked=false; 
  }
}

/* ===== SOV table sync & geocode ===== */
function renderSOV(){
  const tb=document.querySelector('#sovTbl tbody');
  tb.innerHTML=(R.addresses||[]).map((s,i)=>`<tr id="row_${s.id||('A'+i)}" onclick="selectRow('${s.id||('A'+i)}', false)">
    <td>${s.id||('A'+i)}</td>
    <td>${s.line1||''}</td>
    <td>${s.lat??''}</td>
    <td>${s.lon??''}</td>
    <td>${s.tiv?currency(s.tiv):''}</td>
    <td>${s.zone||''}</td>
    <td>
      <div class="row">
        <button class="btn2 small" onclick="event.stopPropagation(); geocodeAddress(${i})"><i data-lucide="map-pin" class="btnIcon"></i> Geocode</button>
      </div>
    </td>
  </tr>`).join('');
  lucide.createIcons();
}
let selId=null;
function selectRow(id, fromMarker){
  selId=id;
  document.querySelectorAll('#sovTbl tbody tr').forEach(r=>r.classList.remove('sel'));
  const row=document.getElementById('row_'+id); if(row){ row.classList.add('sel'); row.scrollIntoView({block:'nearest'}); }
  if(!fromMarker){
    const a=(R.addresses||[]).find(x=>(x.id||'')===id);
    if(a&&a.lat&&a.lon){ map.setView([a.lat,a.lon], Math.max(map.getZoom(), 10)); }
  }
}
async function geocodeAddress(idx){
  const a=R.addresses[idx]; if(!a || !a.line1) return alert('No address text to geocode.');
  try{
    const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(a.line1)}&format=json&limit=1`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const js=await res.json();
    if(js && js[0]){
      a.lat=parseFloat(js[0].lat); a.lon=parseFloat(js[0].lon);
      saveRisk(R); renderSOV(); renderMarkers();
      if(a.lat&&a.lon) map.setView([a.lat,a.lon], 14);
      addAudit('Geocoded address', a.line1);
    } else { alert('No result.'); }
  }catch(e){ console.warn(e); alert('Geocoding failed (CORS or service).'); }
}

/* ===== Actions (modal) & Attestations ===== */
function openActions(){ toggleActions(true); showActionTab('decline'); }
function toggleActions(open){ document.getElementById('actionsModal').style.display=open?'flex':'none'; }
function showActionTab(t){ ['decline','hold','attest'].forEach(x=>document.getElementById('tab-'+x).style.display=(x===t?'block':'none')); }

function confirmDecline(){
  const reason=document.getElementById('declineReason').value, notes=document.getElementById('declineNotes').value.trim();
  if(!reason){ alert('Pick a reason.'); return; }
  if(!confirm('Are you sure you want to NTU / Decline this risk?')) return;
  R.stage='Declined'; saveRisk(R); fillBasics();
  addAudit('NTU/Decline', `Reason: ${reason} • ${notes}`);
  toggleActions(false);
}
function setHoldDays(d){ const dt=new Date(); dt.setDate(dt.getDate()+d); document.getElementById('holdUntil').value = dt.toISOString().slice(0,10); }
function confirmHold(){
  const until=document.getElementById('holdUntil').value; const notes=document.getElementById('holdNotes').value.trim();
  if(!until){ alert('Choose a date.'); return; }
  R.stage='On Hold'; saveRisk(R); fillBasics();
  addAudit('Hold', `Until ${until} • ${notes}`);
  toggleActions(false);
}

/* Attestation log */
function kAtt(){ return 'att_'+R.id; }
function loadAtt(){ try{ return JSON.parse(localStorage.getItem(kAtt())||'[]'); }catch{ return []; } }
function saveAtt(list){ localStorage.setItem(kAtt(), JSON.stringify(list)); renderAtt(); }
function logAtt(action, payload){
  const list=loadAtt(); list.unshift({ts:Date.now(), user:USER, action, payload}); saveAtt(list);
}
function renderAtt(){
  const list=loadAtt(); const box=document.getElementById('attLog');
  if(!list.length){ box.innerHTML='<div class="muted">No attestations recorded.</div>'; return; }
  box.innerHTML=list.map(x=>{
    const when=new Date(x.ts).toLocaleString();
    const details=Object.entries(x.payload||{}).map(([k,v])=>`<span class="tag">${k}: ${String(v)}</span>`).join(' ');
    return `<div class="docRow"><div class="grow"><strong>${x.action}</strong><div class="muted" style="font-size:12px">${when} • ${x.user}</div></div>${details}</div>`;
  }).join('');
}
function attest(type){
  const map={ 'Sanctions':['sanctionsComment','sanctionsRationale'], 'Conduct Risk':['conductComment','conductRationale'], 'ESG':['esgComment','esgRationale'] };
  const [cId,rId]=map[type]; const comment=document.getElementById(cId).value.trim(); const rationale=document.getElementById(rId).value.trim();
  if(!rationale){ alert('Rationale is required.'); return; }
  logAtt(type+' Attestation', {comment, rationale});
  addAudit(type+' Attested', rationale);
  document.getElementById(rId).value='';
  alert(type+' attested.');
}
/* ===== Underwriter Notes (revamped) ===== */
function kNotes(){ return 'notes_'+R.id; }
function loadNotes(){ try{ return JSON.parse(localStorage.getItem(kNotes())||'[]'); }catch{ return []; } }
function saveNotes(list){ localStorage.setItem(kNotes(), JSON.stringify(list)); renderNotes(); }
function toggleNotes(open){ document.getElementById('notesModal').style.display=open?'flex':'none'; }
function openNotes(){ toggleNotes(true); renderNotes(); }
function cleanNote(){ const t=document.getElementById('noteText'); t.value=t.value.replace(/\s+/g,' ').replace(/(^\s+|\s+$)/g,'').replace(/\. ([a-z])/g,(m,p)=>'. '+p.toUpperCase()); }
function saveNote(){
  const title=document.getElementById('noteTitle').value.trim();
  const text=document.getElementById('noteText').value.trim();
  const tags=document.getElementById('noteTags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const pinned=document.getElementById('notePinned').checked;
  if(!title||!text){ alert('Title and text required'); return; }
  const files=[... (document.getElementById('noteAttach').files||[])].map(f=>f.name);
  const list=loadNotes(); list.unshift({id:'n'+Date.now(), title, text, tags, files, user:USER, pinned, ts:Date.now()});
  saveNotes(list);
  document.getElementById('noteTitle').value=''; document.getElementById('noteText').value=''; document.getElementById('noteTags').value=''; document.getElementById('noteAttach').value=''; document.getElementById('notePinned').checked=false;
}
function filterNotesUI(){ renderNotes(document.getElementById('noteFilter').value.trim().toLowerCase()); }
function clearNotesFilter(){ document.getElementById('noteFilter').value=''; renderNotes(); }
function renderNotes(q=''){
  const box=document.getElementById('notesList'); const list=loadNotes();
  const order = (a,b)=> (b.pinned?-1:1) - (a.pinned?-1:1) || (b.ts-a.ts);
  const filt = list.filter(n=> !q || (n.title+n.text+(n.tags||[]).join(' ')).toLowerCase().includes(q)).sort(order);
  if(!filt.length){ box.innerHTML='<div class="muted">No notes yet.</div>'; return; }
  box.innerHTML=filt.map(n=>`
    <div class="noteCard">
      <div class="noteMeta"><strong>${n.title}${n.pinned?' 📌':''}</strong><span>${new Date(n.ts).toLocaleString()} • ${n.user}</span></div>
      <div style="white-space:pre-wrap">${n.text}</div>
      <div>${(n.tags||[]).map(t=>`<span class="tagChip">#${t}</span>`).join(' ')}</div>
      ${n.files?.length?`<div class="muted" style="font-size:12px">Attachments: ${n.files.join(', ')}</div>`:''}
    </div>`).join('');
}

/* ===== Edit Drawer ===== */
function openEditDrawer(){ populateEditForm(); document.getElementById('editDrawer').classList.add('open'); }
function closeEditDrawer(){ document.getElementById('editDrawer').classList.remove('open'); }
function pickBroker(v){
  if(!v) return; const [org,name,email,phone]=v.split('|');
  document.getElementById('ed_broker_org').value=org; document.getElementById('ed_broker_name').value=name; document.getElementById('ed_broker_email').value=email; document.getElementById('ed_broker_phone').value=phone;
}
function populateEditForm(){
  const ib=document.getElementById('insuredsBox'); ib.innerHTML='';
  (R.insureds||[]).forEach((ins,i)=>ib.appendChild(insuredRow(ins,i)));
  const ab=document.getElementById('addressesBox'); ab.innerHTML='';
  (R.addresses||[]).forEach((ad,i)=>ab.appendChild(addressRow(ad,i)));

  document.getElementById('ed_inception').value=R.eff||'';
  document.getElementById('ed_expiry').value=R.exp||'';
  document.getElementById('ed_lob').value=R.lob||'';
  document.getElementById('ed_product').value=R.product||'';
  document.getElementById('ed_placement').value=R.placement||'Open Market';
  document.getElementById('ed_domicile').value=R.domicile||'';
  document.getElementById('ed_currency').value=R.currency||'USD';
  document.getElementById('ed_exposure').value=R.exposure||'';
  document.getElementById('ed_written').value=R.written||'';
  document.getElementById('ed_signed').value=R.signed||'';
  document.getElementById('ed_commission').value=R.commission||'';
  document.getElementById('ed_broker_org').value=R.broker?.org||'';
  document.getElementById('ed_broker_name').value=R.broker?.contact||'';
  document.getElementById('ed_broker_email').value=R.broker?.email||'';
  document.getElementById('ed_broker_phone').value=R.broker?.phone||'';
  lucide.createIcons();
}
function insuredRow(ins,i){
  const div=document.createElement('div'); div.className='row'; div.style.alignItems='center';
  div.innerHTML=`
    <input class="input" id="ins_name_${i}" value="${ins.name||''}" placeholder="Name"/>
    <input class="input" id="ins_role_${i}" value="${ins.role||''}" placeholder="Role (Parent/Subsidiary/Branch)"/>
    <label class="badge"><input type="checkbox" id="ins_primary_${i}" ${ins.primary?'checked':''}> Primary</label>
    <button class="btn2 small" onclick="removeInsured(${i})"><i data-lucide="trash" class="btnIcon"></i> Remove</button>`;
  return div;
}
function addressRow(ad,i){
  const div=document.createElement('div'); div.className='row'; div.style.alignItems='center';
  div.innerHTML=`
    <input class="input" id="ad_line_${i}" value="${ad.line1||''}" placeholder="Address line"/>
    <input class="input" id="ad_lat_${i}" value="${ad.lat??''}" type="number" step="0.000001" placeholder="Lat"/>
    <input class="input" id="ad_lon_${i}" value="${ad.lon??''}" type="number" step="0.000001" placeholder="Lon"/>
    <input class="input" id="ad_tiv_${i}" value="${ad.tiv??''}" type="number" placeholder="TIV"/>
    <input class="input" id="ad_zone_${i}" value="${ad.zone||''}" placeholder="Flood Zone"/>
    <label class="badge"><input type="checkbox" id="ad_primary_${i}" ${ad.primary?'checked':''}> Primary</label>
    <button class="btn2 small" onclick="geocodeFromEdit(${i})"><i data-lucide="map-pin" class="btnIcon"></i> Geocode</button>
    <button class="btn2 small" onclick="removeAddress(${i})"><i data-lucide="trash" class="btnIcon"></i> Remove</button>`;
  return div;
}
function addInsured(){ (R.insureds=R.insureds||[]).push({name:'',role:'',primary:false}); populateEditForm(); }
function removeInsured(i){ R.insureds.splice(i,1); populateEditForm(); }
function addAddress(){ (R.addresses=R.addresses||[]).push({id:'A'+Date.now(), line1:'', primary:false}); populateEditForm(); }
function removeAddress(i){ R.addresses.splice(i,1); populateEditForm(); }
async function geocodeFromEdit(i){
  const addr=document.getElementById('ad_line_'+i).value; if(!addr) return alert('Enter an address.');
  try{
    const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json&limit=1`;
    const rs=await fetch(url); const js=await rs.json();
    if(js&&js[0]){ document.getElementById('ad_lat_'+i).value=js[0].lat; document.getElementById('ad_lon_'+i).value=js[0].lon; chipToast('Geocoded'); }
    else alert('No result');
  }catch(e){ alert('Geocoding failed'); }
}
function saveRiskEdits(){
  const newIns=[]; (R.insureds||[]).forEach((_,i)=>{ const name=document.getElementById('ins_name_'+i).value.trim(); const role=document.getElementById('ins_role_'+i).value.trim(); const primary=document.getElementById('ins_primary_'+i).checked; if(name) newIns.push({name,role,primary}); });
  if(newIns.length){
    if(!newIns.some(x=>x.primary)) newIns[0].primary=true;
    else { const firstPrimary=newIns.findIndex(x=>x.primary); newIns.forEach((x,idx)=>{ if(idx!==firstPrimary) x.primary=false; }); }
  }
  R.insureds=newIns;

  const newAd=[]; (R.addresses||[]).forEach((_,i)=>{ const id=R.addresses[i].id||('A'+i);
    const line1=document.getElementById('ad_line_'+i).value.trim();
    const lat=parseFloat(document.getElementById('ad_lat_'+i).value)||null; const lon=parseFloat(document.getElementById('ad_lon_'+i).value)||null;
    const tiv=parseFloat(document.getElementById('ad_tiv_'+i).value)||null; const zone=document.getElementById('ad_zone_'+i).value.trim()||null;
    const primary=document.getElementById('ad_primary_'+i).checked;
    if(line1) newAd.push({id, line1, lat, lon, tiv, zone, primary});
  });
  if(newAd.length){
    if(!newAd.some(x=>x.primary)) newAd[0].primary=true;
    else { const p=newAd.findIndex(x=>x.primary); newAd.forEach((x,i)=>{ if(i!==p) x.primary=false; }); }
  }
  R.addresses=newAd;

  R.eff=document.getElementById('ed_inception').value||R.eff;
  R.exp=document.getElementById('ed_expiry').value||R.exp;
  R.lob=document.getElementById('ed_lob').value||R.lob;
  R.product=document.getElementById('ed_product').value||R.product;
  R.placement=document.getElementById('ed_placement').value||R.placement;
  R.domicile=document.getElementById('ed_domicile').value||R.domicile;
  R.currency=document.getElementById('ed_currency').value||R.currency;

  R.exposure=parseFloat(document.getElementById('ed_exposure').value)||R.exposure;
  R.written=parseFloat(document.getElementById('ed_written').value)||R.written;
  R.signed=parseFloat(document.getElementById('ed_signed').value)||R.signed;
  R.commission=parseFloat(document.getElementById('ed_commission').value)||R.commission;

  R.broker={ org:document.getElementById('ed_broker_org').value||'', contact:document.getElementById('ed_broker_name').value||'', email:document.getElementById('ed_broker_email').value||'', phone:document.getElementById('ed_broker_phone').value||'' };

  const reason=document.getElementById('ed_reason').value.trim();

  saveRisk(R);
  fillBasics(); renderSOV(); renderMarkers();
  addAudit('Risk edited', reason||'—');
  closeEditDrawer();
}


/* ===== Toast ===== */
let TO;
function chipToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(TO); TO=setTimeout(()=>t.style.display='none', 2200); }

/* ===== Init ===== */
function init(){
  fillBasics(); renderLoss(); renderRecs();
  loadDocs(); renderDocs();
  renderAtt();
  renderTimeline();
  renderSOV();
  initMap();

  // NEW
  renderWordingPicker();
  // (renderRecs already called at the top — fine to leave as-is)
}
init();
lucide.createIcons();
// Ensure timeline is rendered after icons are loaded
setTimeout(() => renderTimeline(), 100);


/* ===== Notes Pop-out (advanced) ===== */
function popOutNotes(){
  const data = loadNotes();
  const title = (R.insureds?.[0]?.name || 'Risk Notes') + ' — Notes';
  const w = window.open('', 'notes_'+R.id, 'width=1100,height=760,noopener');
  if(!w){ alert('Please allow pop-ups for the notes window.'); return; }

  const payload = JSON.stringify(data || []);
  const css = `
    :root{--border:#E6E9EE;--muted:#6B757E;--brand:#6F1111}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui;background:#F7F8FA;color:#0F1216}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;background:#fff;border-bottom:1px solid var(--border)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#7A1414,#6F1111);color:#fff;border-color:transparent}
    .input{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;min-width:280px}
    main{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px}
    .hd{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:800}
    .bd{padding:12px 14px}
    .muted{color:var(--muted)}
    .timeline{position:relative;padding-left:18px;max-height:calc(100vh - 170px);overflow:auto}
    .timeline::before{content:"";position:absolute;left:8px;top:8px;bottom:8px;width:2px;background:#E5E7EB}
    .titem{position:relative;margin:0 0 12px 0;padding-left:10px}
    .dot{position:absolute;left:-2px;top:4px;width:10px;height:10px;border-radius:999px;border:2px solid #fff;box-shadow:0 0 0 2px #E5E7EB;background:#6B7280}
    .note{border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;display:grid;gap:6px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--muted)}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}
    .list{display:grid;gap:10px;max-height:calc(100vh - 170px);overflow:auto}
  `;

  const html = `
  <!doctype html><html><head><meta charset="utf-8">
  <title>${title}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>${css}</style></head>
  <body>
    <header>
      <div class="row"><strong style="font-size:18px">${title}</strong><span class="muted" id="count"></span></div>
      <div class="row">
        <input id="q" class="input" placeholder="Search notes or #tags">
        <button class="btn" onclick="filter()">Search</button>
        <button class="btn2 small" onclick="showActionTab('loss')">
          <i data-lucide="table" class="btnIcon"></i> Loss Runs </button>
        <button class="btn" onclick="clearQ()">Clear</button>
        <button class="btn primary" onclick="window.print()">Print</button>
        <button class="btn" onclick="window.close()">Close</button>
      </div>
    </header>
    <main>
      <section class="card">
        <div class="hd">Timeline</div>
        <div id="timeline" class="bd timeline"></div>
      </section>
      <section class="card">
        <div class="hd">Notes</div>
        <div id="notes" class="bd list"></div>
      </section>
    </main>
    <script>
      const NOTES = ${payload};
      const notesBox = document.getElementById('notes');
      const timeBox = document.getElementById('timeline');
      const countEl = document.getElementById('count');
      let Q = '';

      function render(){
        const filtered = (NOTES||[]).filter(n=>{
          if(!Q) return true;
          const hay = (n.title+' '+n.text+' '+(n.tags||[]).join(' ')).toLowerCase();
          return hay.includes(Q);
        }).sort((a,b)=> (b.pinned?-1:1)-(a.pinned?-1:1) || b.ts-a.ts);

        countEl.textContent = filtered.length + ' of ' + (NOTES?.length||0);

        notesBox.innerHTML = filtered.map(n => \`
          <article class="note">
            <div class="meta"><strong>\${n.title}\${n.pinned?' 📌':''}</strong><span>\${new Date(n.ts).toLocaleString()} • \${n.user||''}</span></div>
            <div style="white-space:pre-wrap">\${n.text}</div>
            <div class="tags">\${(n.tags||[]).map(t=>'<span class="chip">#'+t+'</span>').join(' ')}</div>
            \${n.files?.length?'<div class="muted" style="font-size:12px">Attachments: '+n.files.join(', ')+'</div>':''}
          </article>\`).join('') || '<div class="muted">No notes</div>';

        timeBox.innerHTML = filtered.map(n => \`
          <div class="titem">
            <span class="dot"></span>
            <div class="note" style="cursor:default">
              <div class="meta"><strong>\${n.title}</strong><span>\${new Date(n.ts).toLocaleString()}</span></div>
              <div class="muted" style="font-size:12px">\${(n.tags||[]).map(t=>'#'+t).join(' • ')}</div>
            </div>
          </div>\`).join('') || '<div class="muted">No timeline events</div>';
      }
      function filter(){ Q = (document.getElementById('q').value||'').toLowerCase().trim(); render(); }
      function clearQ(){ document.getElementById('q').value=''; Q=''; render(); }
      render();
    <\/script>
  </body></html>`;

  w.document.open();
  w.document.write(html);
  w.document.close();
}
  </script>
  <script src="workflow.js" defer onload="console.log('workflow.js loaded')"></script>
</body>
</html>